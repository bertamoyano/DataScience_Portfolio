---
output:
  pdf_document:
    number_sections: true
    toc: true
    toc_depth: 3
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

\pagebreak

# Definició de projecte i assignació

## Font d'obtenció de les dades

Les dades han estat extretes del repositori de bases de dades Kaggle. L'enllaç de la pàgina web és el següent: <https://www.kaggle.com/datasets/thedevastator/higher-education-predictors-of-studentretention>

Aquí se citen els autors de la base de dades:

*VALORIZA---Research Center for Endogenous Resource Valorization, Instituto Politécnico de Portalegre, 7300-555 Portalegre, Portugal.*

*Escola Superior de Tecnologia e Gestão, Instituto Politécnico de Portalegre, 7300-555 Portalegre, Portugal.*

## Informació de les dades

La base de dades inclou diversos casos de dades demogràfiques, socioeconòmiques i macroeconòmiques d'alumnes universitaris, així com els seus resultats acadèmics entre el 2008 i el 2018. Aquests resultats s'enforcaran com a variable resposta, per procurar establir una relació entre l'èxit acadèmic i les altres variables.

Aquestes inclouen dades de 17 graus universitaris de diferents camps de coneixement, com l'agronomia, el disseny, l'educació, la infermeria, el periodisme, la gestió, el servei social i tecnologies.

## Estructura i informació de la matriu de dades

```{r, echo = FALSE}
setwd("~/GitHub/analisi-multivariant/treball")
dades <- read.csv("data.csv", sep = ",")
```

```{r, echo = FALSE}
files <- dim(dades)[1]
col <- dim(dades)[2]-1
```

| **Files (individus)** | **Columnes (variables)** | **Nre. variables numèriques** | **Nre. variables categòriques** |
|:---------------:|:---------------:|:-----------------:|:------------------:|
|       `r files`       |         `r col`          |              8               |               10                |

**INFORMACIÓ DEMOGRÀFICA**

| **Nom** | **Descripció** | **Tipus** | **Diccionari i domini** |
|:--------|:--------|:------|:----------------------------|
| Nationality | Nacionalitat | Categòrica | 1—Portuguese, 2—German, 3—Spanish 4—Italian, 5—Dutch, 6—English, 7—Lithuanian, 8—Angolan, 9—Cape Verdean, 10—Guinean, 11—Mozambican, 12—Santomean, 13—Turkish, 14—Brazilian, 15—Romanian, 16—Moldova, 17—Mexican, 18—Ukrainian, 19—Russian, 20—Cuban, 21—Colombian |
| Gender | Gènere | Categòrica | 1—Male, 0—Female |
| Age | Edat | Numèrica | Rang a les dades [17, 70] |

**DADES SOCIOECONÒMIQUES**

| **Nom** | **Descripció** | **Tipus** | **Diccionari i domini** |
|:--------|:--------|:------|:----------------------------|
| Scholarship holder | Becari | Categòrica binària | 1—Yes, 0—No |
| Mother's occupation & Father's occupation | Ocupació de la mare i Ocupació del pare | Categòrica | 1—Student, 2—Representatives of the Legislative Power and Executive Bodies, Directors, Directors and Executive Managers, 3—Specialists in Intellectual and Scientific Activities, 4—Intermediate Level Technicians and Professions, 5—Administrative staff, 6—Personal Services, Security and Safety Workers, and Sellers, 7—Farmers and Skilled Workers in Agriculture, Fisheries, and Forestry, 8—Skilled Workers in Industry, Construction, and Craftsmen, 9—Installation and Machine Operators and Assembly Workers, 10—Unskilled Workers, 11—Armed Forces Professions, 12—Other Situation, 13—(blank), 14—Armed Forces Officers, 15—Armed Forces Sergeants, 16—Other Armed Forces personnel, 17—Directors of administrative and commercial services, 18—Hotel, catering, trade, and other services directors, 19—Specialists in the physical sciences, mathematics, engineering, and related techniques, 20—Health professionals, 21—Teachers, 22—Specialists in finance, accounting, administrative organization, and public and commercial relations, 23—Intermediate level science and engineering technicians and professions, 24—Technicians and professionals of intermediate level of health, 25—Intermediate level technicians from legal, social, sports, cultural, and similar services, 26—Information and communication technology technicians, 27—Office workers, secretaries in general, and data processing operators, 28—Data, accounting, statistical, financial services, and registry-related operators,29—Other administrative support staff, 30—Personal service workers, 31—Sellers, 32—Personal care workers and the like, 33—Protection and security services personnel, 34—Market-oriented farmers and skilled agricultural and animal production workers, 35—Farmers, livestock keepers, fishermen, hunters and gatherers, and subsistence, 36—Skilled construction workers and the like, except electricians, 37—Skilled workers in metallurgy, metalworking, and similar, 38—Skilled workers in electricity and electronics, 39—Workers in food processing, woodworking, and clothing and other industries and crafts, 40—Fixed plant and machine operators, 41—Assembly workers, 42—Vehicle drivers and mobile equipment operators, 43—Unskilled workers in agriculture, animal production, and fisheries and forestry, 44—Unskilled workers in extractive industry, construction, manufacturing, and transport, 45—Meal preparation assistants, 46—Street vendors (except food) and street service providers |
| Educational special needs | Necessitats especials en l'educació | Categòrica binària | 1—Yes, 0—No |

**DADES MACROECONÒMIQUES**

| **Nom** | **Descripció** | **Tipus** | **Diccionari i domini** |
|:--------|:--------|:------|:----------------------------|
| Unemployment rate | Taxa d'atur | Numèrica | Rang a les dades [7.6, 16.2] |
| Inflation rate | Taxa d'inflació | Numèrica | Rang a les dades [-0.8 , 3,7] |
| GDP | PIB | Numèrica | Rang a les dades [-4.1, 3.5] |

**DADES ACADÈMIQUES A LA INSCRIPCIÓ**

| **Nom** | **Descripció** | **Tipus** | **Diccionari i domini** |
|:--------|:--------|:------|:----------------------------|
| Course | Curs | Categòrica | 1—Biofuel Production Technologies, 2—Animation and Multimedia Design, 3—Social Service (evening attendance), 4—Agronomy, 5—Communication Design, 6—Veterinary Nursing, 7—Informatics Engineering, 8—Equiniculture, 9—Management, 10—Social Service, 11—Tourism, 12—Nursing, 13—Oral Hygiene, 14—Advertising and Marketing Management, 15—Journalism and Communication, 16—Basic Education, 17—Management (evening attendance) |
| Attendance | Assistència | Categòrica binària | 1—Daytime, 0—Evening |
| Previous qualification | Qualificació prèvia | Categòrica | 1—Secondary education, 2—Higher education—bachelor's degree, 3—Higher education—degree, 4—Higher education—master's degree, 5—Higher education—doctorate, 6—Frequency of higher education, 7—12th year of schooling—not completed, 8—11th year of schooling—not completed, 9—Other—11th year of schooling, 10—10th year of schooling, 11—10th year of schooling—not completed, 12—Basic education 3rd cycle (9th/10th/11th year) or equivalent, 13—Basic education 2nd cycle (6th/7th/8th year) or equivalent, 14—Technological specialization course, 15—Higher education—degree (1st cycle), 16—Professional higher technical course, 17—Higher education—masters degree (2nd cycle) |

\pagebreak

**DADES ACADÈMIQUES AL FINAL DEL 1r SEMESTRE**

| **Nom** | **Descripció** | **Tipus** | **Diccionari i domini** |
|:--------|:--------|:------|:----------------------------|
| Curricular units 1st sem grades | Unitats curriculars 1r semestre notes | Numèrica | Rang a les dades [0, 18.875] |
| Curricular units 1st sem without evalutions | Unitats curriculars 1r semestre sense avaluacions | Numèrica | Rang a les dades [0, 12] |

**DADES ACADÈMIQUES AL FINAL DEL 2n SEMESTRE**

| **Nom** | **Descripció** | **Tipus** | **Diccionari i domini** |
|:--------|:--------|:------|:----------------------------|
| Curricular units 2nd sem grades | Unitats curriculars 2n semestre notes | Numèrica | Rang a les dades [0, 18.571] |
| Curricular units 2nd sem without evalutions | Unitats curriculars 2n semestre sense avaluacions | Numèrica | Rang a les dades [0, 12] |

**VARIABLE D'OUTPUT**

| **Nom** | **Descripció** | **Tipus** | **Diccionari i domini** |
|:--------|:--------|:------|:----------------------------|
| Target | Target | Categòrica | Graduate, Dropout, Enrolled |

## Missings

```{r, echo = FALSE}
library(dplyr)
dades$Mother.s.qualification <- na_if(dades$Mother.s.qualification, 24)
dades$Father.s.qualification <- na_if(dades$Father.s.qualification, 24)

# Missings totals
nre <- sum(is.na(dades))

# Percentatge missings totals
perc <- round(sum(is.na(dades))/(nrow(dades)*ncol(dades))*100, 4)
```

| **Nre. de caselles** | **Respecte del total de la matriu dades** |
|:--------------------:|:-----------------------------------------:|
|       `r nre`        |                 `r perc`%                 |

```{r, echo = FALSE, out.width="70%"}
# Percentatge missings per variable
# round((colSums(is.na(dades))/nrow(dades))*100, 4)

b <- (colSums(is.na(dades))/nrow(dades))*100

b1 <- b > 0

round(b[b1], 4)

barplot(b[b1], ylim = c(0,3), col = 2, ylab = '%')
```

Al gràfic només s'han representat les variables que tenen algun missing.

\pagebreak

# Pla de treball

## Diagrama de Gantt

Per tal de complir els objectius del treball i seguir tots els punts que consten en el guió, s'ha dividit la feina en les següents tasques a desenvolupar.

1.  Motivació del treball, descripció formal de les dades i profiling de les dades crues

2.  Preprocessament

3.  Profiling dades preprocessades i clustering jeràrquic

4.  Preparar informe D3 i presentació 1

5.  ACP i ACM

6.  Clustering jeràrquic de l'ACP i l'ACM

7.  Anàlisi comparativa

8.  Conclusions

9.  Pla de treball real

10. Preparar informe D4 i presentació 2

Aquesta és la planificació de quan es duran a terme cadascuna de les tasques.

```{r, echo = FALSE}
library(reshape2)
library(ggplot2)

df <- data.frame(
  name = factor(c("Tasca 01", "Tasca 02", "Tasca 03", "Tasca 04", "Tasca 05", "Tasca 06", "Tasca 07", "Tasca 08", "Tasca 09", "Tasca 10")),
  inici  = as.Date(c("2023-03-02", "2023-03-09", "2023-03-23", "2023-04-06", "2023-04-13", "2023-04-20", "2023-04-27", "2023-05-04", "2023-05-11", "2023-05-18")),
  final = as.Date(c("2023-03-08", "2023-03-22", "2023-04-05", "2023-04-12", "2023-04-19", "2023-04-26", "2023-05-03", "2023-05-10", "2023-05-17", "2023-05-24")))

ggplot (df, aes (x = inici, xend = final, y = name, yend = name, colour = name)) + 
  theme_bw () +
  geom_segment (size = 8) +
  labs (title = 'Diagrama de Gantt', x = NULL, y = NULL, legend = NULL) +
  geom_area(stat="identity") +
  theme(legend.position="none")
```

## Assignació de tasques

Les tasques descrites en l'anterior secció s'han repartit entre els integrants del grup de la següent manera:

```{r, echo = FALSE}
df <- data.frame(
  tasques = factor(c("Motivació treball", "Descripció formal dades", "Profiling dades crues", "Preprocessament", "Profiling dades preprocessades", "Clustering jeràrquic", "Informe D3 i presentació 1", "ACP", "ACM", "Clustering jeràrquic ACP i ACM", "Anàlisi comparativa", "Conclusions", "Pla de treball real", "Informe D4 i presentació 2")),
  assignacio = factor(c("Grup 1", "Grup 2", "Grup 3", "Grup 4", "Grup 2", "Grup 1", "Tothom", "Grup 3", "Grup 4", "Grup 1", "Grup 2", "Tothom", "Grup 4", "Tothom")))
```

| Tasca                          | Aina i Oscar | Lucía i Laura T. | Mireia i Laura V. | Berta i Albert |
|-------------------|:------------:|:------------:|:------------:|:------------:|
| Motivació treball              |      X       |                  |                   |                |
| Descripció formal dades        |              |        X         |                   |                |
| Profiling dades crues          |              |                  |         X         |                |
| Preprocessament                |              |                  |                   |       X        |
| Profiling dades preprocessades |              |        X         |                   |                |
| Clustering jeràrquic           |      X       |                  |                   |                |
| Informe D3 i presentació 1     |      X       |        X         |         X         |       X        |
| ACP                            |              |                  |         X         |                |
| ACM                            |              |                  |                   |       X        |
| Clustering jeràrquic ACP i ACM |      X       |                  |                   |                |
| Anàlisi comparativa            |              |        X         |                   |                |
| Conclusions                    |      X       |        X         |         X         |       X        |
| Pla treball real               |              |                  |                   |       X        |
| Informe D4 i presentació 2     |      X       |        X         |         X         |       X        |

## Pla de riscos

Com prèviament s'ha indicat, s'ha organitzat els temps de durada i l'ordre de cada tasca en un diagrama de Gantt. Així, amb la premissa de prevenir que qualsevol imprevist s'agreugi i poder continuar aquesta planificació, s'han pactat els següents punts com a pla de riscos:

| Risc                                                                                                  | Impacte | Solució                                                                                                                      |
|--------------------------|:------------:|---------------------------------|
| Falta de temps acadèmic, retard en les tasques                                                        |   Alt   | Planificació amb suficient antelació. Si cal, reajustar el calendari, allargar i escurçar terminis.                          |
| Pèrdua de documents                                                                                   |   Alt   | Possible recuperació de versions anteriors. Tenir còpies de totes les actualitzacions (Drive i GitHub).                      |
| Renúncia o pèrdua de l'avaluació contínua                                                             | Moderat | Es reorganitzen els grups.                                                                                                   |
| Incapacitat per treballar (indisposició, malalties, problemes personals, problemes informàtics, etc.) | Moderat | Si la tasca té poc pes, la fa la parella. Si és molta feina, s'encarrega un altre grup que no tingui cap tasca en el moment. |
| Conflictes entre parelles                                                                             |  Baix   | Intentar solucionar els problemes amb ajuda d'algun membre com a mediador. Si no s'aconsegueix, reestructuració dels grups.  |

L'impacte fa referència al nivell del risc i, per tant, la prioritat que se li ha de donar a aquest.

\pagebreak

# Estructura de les dades i descriptiva

## Selecció de columnes

Abans de començar a explorar les dades i treballar sobre elles se seleccionen les columnes que més ens interessen de la base de dades escollida pel treball. Les columnes se seleccionen de tal manera que compleixin els requisits plantejats, un mínim de 7 columnes numèriques i un mínim de 7 categòriques, on almenys 2 són binàries. Les columnes amb les quals ens quedem s'han explicat en la secció anterior d'aquest informe.

Per tal de facilitar la interpretació de les dades al llarg del treball, també es recodifiquen les variables categòriques amb el valor que correspon a cada nivell. Per exemple, per a la variable binària *daytime_attendance*, s'assigna el valor *Daytime* als 0's i *Evening* als 1's, d'acord amb el diccionari que acompanyava la base de dades. D'aquesta manera, els diferents nivells de les variables categòriques poden interpretar-se directament.

També s'arrodoneixen a dos decimals els valors de les variables numèriques per facilitar la comprensió i simplificar les dades a l'hora de treballar. Arrodonir valors numèrics no és problema en aquest cas, ja que donada la naturalesa de les variables aquest arrodoniment no provoca cap pèrdua d'informació ni ambigüitat entre valors.

Finalment, com que la base de dades no conté *missing values*, s'afegeixen uns quants artificialment de forma aleatòria per tal de poder treballar les tècniques de *missing values* vistes a classe. Aquests *missing values* simulats es creen proporcionalment i s'ha imposat que suposin un 5% dels valors de la base de dades.

```{r, echo = FALSE}
# Subset data to keep only relevant columns
df = read.csv("data.csv", header = TRUE)

cols_to_keep = c(
  'Curricular.units.1st.sem..without.evaluations.',
  'Curricular.units.2nd.sem..without.evaluations.',
  'Age.at.enrollment', 'Unemployment.rate', 'GDP',
  'Inflation.rate', 'Nacionality', 'Course',
  'Curricular.units.1st.sem..grade.', 'Gender',
  'Curricular.units.2nd.sem..grade.', 'Target',
  'Father.s.occupation', 'Mother.s.occupation',
  'Previous.qualification', 'Daytime.evening.attendance',
  'Scholarship.holder', 'Educational.special.needs'
)

df_ = df[, names(df) %in% cols_to_keep]
# names(df_)
```

```{r, echo = FALSE}
# Rename cols
colnames(df_) = c('course', 'daytime_attendance', 'previous_qualification', 'nationality', 
                        'occupation_mother', 'occupation_father', 'special_needs', 'gender', 
                        'scholarship', 'age', 'grades_sem_1', 'no_eval_sem_1', 'grades_sem_2', 
                        'no_eval_sem_2', 'unemployment_rate', 'inflation_rate', 'gdp', 'target')

# Convert categorical cols as factors
cat_cols = c('course', 'daytime_attendance', 'nationality', 'occupation_mother', 'occupation_father',
             'special_needs', 'gender', 'scholarship', 'target', 'previous_qualification')

df_[cat_cols] = lapply(df_[cat_cols], factor)

# Rename factor levels
library(dplyr)

df_$course = recode(df_$course, '1' = 'Biofuel Production Technologies', '2' = 'Animation and Multimedia Design', '3' = 'Social Service (evening)', '4' = 'Agronomy', '5' = 'Communication Design', '6' = 'Veterinary Nursing', '7' = 'Informatics Engineering', '8' = 'Equiniculture', '9' = 'Management', '10' = 'Social Service', '11' = 'Tourism', '12' = 'Nursing', '13' = 'Oral Hygiene', '14' = 'Advertising and Marketing Management', '15' = 'Journalism and Communication', '16' = 'Basic Education', '17' = 'Management (evening)')

df_$daytime_attendance = recode(df_$daytime_attendance, '1' = 'Daytime', '0' = 'Evening')

df_$nationality = recode(df_$nationality, '1' = 'Portuguese', '2' = 'German', '3' = 'Spanish', '4' = 'Italian', '5' = 'Dutch', '6' = 'English', '7' = 'Lithuanian', '8' = 'Angolan', '9' = 'Cape Verdean', '10' = 'Guinean', '11' = 'Mozambican', '12' = 'Santomean', '13' = 'Turkish', '14' = 'Brazilian', '15' = 'Romanian', '16' = 'Moldova', '17' = 'Mexican', '18' = 'Ukranian', '19' = 'Russian', '20' = 'Cuban', '21' = 'Colombian')

df_$occupation_mother = recode(df_$occupation_mother, '1' = 'Student', '2' = 'Executive Manager or Legislative Representative', '3' = 'Intellectual Specialist', '4' = 'Technician or Professor', '5' = 'Administrative Staff', '6' = 'Safety Worker', '7' = 'Agriculture, Fishery and Forestry Worker', '8' = 'Construction', '9' = 'Installation Worker', '10' = 'Unskilled Worker', '11' = 'Army Soldier', '12' = 'Other', '13' = 'Blank', '14' = 'Army Officer', '15' = 'Army Sergeant', '16' = 'Army Other', '17' = 'Administrative Director', '18' = 'Hospitality Director', '19' = 'STEM Specialist', '20' = 'Health Professional', '21' = 'Teacher', '22' = 'Finance Specialist', '23' = 'STEM Intermediate Level', '24' = 'Health Technican', '25' = 'Legal or Cultural Technician', '26' = 'Information and Communication Technician', '27' = 'Office Worker', '28' = 'Accounting or Financial Services', '29' = 'Other Administrative Support Staff', '30' = 'Personal Service Worker', '31' = 'Seller', '32' = 'Personal Care Worker', '33' = 'Security Service Personnel', '34' = 'Skilled Agricultural Worker', '35' = 'Subsistence Hunter and Gatherer', '36' = 'Skilled Construction Worker', '37' = 'Skilled Metallurgy Worker', '38' = 'Skilled Electricity Worker', '39' = 'Craft Worker', '40' = 'Machine Operator', '41' = 'Assembly Worker', '42' = 'Mobile Equipment Operator', '43' = 'Unskilled Agricultural Worker', '44' = 'Unskilled Construction and Manufacturing Worker', '45' = 'Meal Preparation Assistant', '46' = 'Street Vendor')

df_$occupation_father = recode(df_$occupation_father, '1' = 'Student', '2' = 'Executive Manager or Legislative Representative', '3' = 'Intellectual Specialist', '4' = 'Technician or Professor', '5' = 'Administrative Staff', '6' = 'Safety Worker', '7' = 'Agriculture, Fishery and Forestry Worker', '8' = 'Construction', '9' = 'Installation Worker', '10' = 'Unskilled Worker', '11' = 'Army Soldier', '12' = 'Other', '13' = 'Blank', '14' = 'Army Officer', '15' = 'Army Sergeant', '16' = 'Army Other', '17' = 'Administrative Director', '18' = 'Hospitality Director', '19' = 'STEM Specialist', '20' = 'Health Professional', '21' = 'Teacher', '22' = 'Finance Specialist', '23' = 'STEM Intermediate Level', '24' = 'Health Technican', '25' = 'Legal or Cultural Technician', '26' = 'Information and Communication Technician', '27' = 'Office Worker', '28' = 'Accounting or Financial Services', '29' = 'Other Administrative Support Staff', '30' = 'Personal Service Worker', '31' = 'Seller', '32' = 'Personal Care Worker', '33' = 'Security Service Personnel', '34' = 'Skilled Agricultural Worker', '35' = 'Subsistence Hunter and Gatherer', '36' = 'Skilled Construction Worker', '37' = 'Skilled Metallurgy Worker', '38' = 'Skilled Electricity Worker', '39' = 'Craft Worker', '40' = 'Machine Operator', '41' = 'Assembly Worker', '42' = 'Mobile Equipment Operator', '43' = 'Unskilled Agricultural Worker', '44' = 'Unskilled Construction and Manufacturing Worker', '45' = 'Meal Preparation Assistant', '46' = 'Street Vendor') 

df_$special_needs = recode(df_$special_needs, '1' = 'Yes', '0' = 'No')

df_$gender = recode(df_$gender, '1' = 'Male', '0' = 'Female')

df_$previous_qualification = recode(df_$previous_qualification, '1' = 'Secondary education', '2' = "Bachelor's degree", '3' = 'Degree', '4' = "Master's degree", '5' = 'PhD', '6' = 'Frequency of higher education', '7' = '12th year incomplete', '8' = '11th year incomplete', '9' = '11th year other', '10' = '10th year of schooling', '11' = '10th year of schooling incomplete', '12' = 'Basic education 3rd cycle', '13' = 'Basic education 2nd cycle', '14' = 'Technological specialization course', '15' = 'Degree (1st cycle)', '16' = 'Professional higher technical course', '17' = "Master's degree (2nd cycle)")

df_$scholarship = recode(df_$scholarship, '1' = 'Yes', '0' = 'No')

# Round grade columns
df_$grades_sem_1 = round(df_$grades_sem_1, 2)
df_$grades_sem_2 = round(df_$grades_sem_2, 2)

# Artificially add random NAs to our data
raw_data = as.data.frame(lapply(df_, function(cc) cc[sample(c(TRUE, NA), prob = c(0.95, 0.05), size = length(cc), replace = TRUE)]))

# save(raw_data, file = 'raw_data.Rdata')
```

## Anàlisi descriptiva abans del preprocessing

En aquesta secció es fa una anàlisi descriptiva (univariant i bivariant) de les dades crues abans del preprocessing.

```{r}
library(ggplot2)
library(knitr)
library(summarytools)
library(tidyverse)

profiling = function(X, col_name, data){
  if (!(is.numeric(X) || class(X)=="Date")){ 
    freqs = table(as.factor(X), useNA = "no"); 
    proportions = freqs/nrow(data)
    df = data.frame(x = levels(as.factor(X)), y = freqs)
    par(mfrow = c(1,2))
    print(ggplot(df, aes(x = "", y = freqs, fill = x)) + geom_bar(stat = "identity",
    width = 1) + scale_y_continuous(expand = c(0,0)) + coord_polar("y", start = 0) + 
    theme_minimal())
    print(ggplot(df, aes(x = x, y = freqs)) + geom_bar(stat = "identity", color =
    "lightblue", fill = "lightblue") + 
    geom_text(aes(label = x), nudge_y = -5, size = 3) + 
    scale_y_continuous(expand = c(0,0), name = "Frequency") + 
    scale_x_discrete(name = col_name) + 
    theme_minimal() +
    theme(axis.text.x = element_blank(), 
          axis.ticks.x = element_blank(), 
          axis.text.y = element_text(size = 10),
          axis.line.x = element_line(color = "black", size = 0.5),
          panel.grid.major.y = element_line(color = "gray", size = 0.2)))
    x = data.frame(X)
    colnames(x) = col_name
    st_options(plain.ascii  = FALSE,  headings = FALSE, footnote = NA, style = 'grid',
               dfSummary.varnumbers = FALSE, dfSummary.valid.col = FALSE, tmp.img.dir  = "img",
               round.digits = 3, dfSummary.silent=TRUE, dfSummary.graph.col= FALSE)
    dfSummary(x)
    
   }else{
      print(ggplot(data, aes(x = X)) + geom_bar(col = "lightblue", fill = "lightblue") + theme_minimal())
       taula = descr(X, transpose = TRUE, style = "rmarkdown", justify = "center", 
                 stats = c("N.Valid", "min", "q1", "med", "mean", "sd", "q3", "max", "iqr"))
       rownames(taula) = NULL
       print(taula)
   }
}
```

```{r}
load('raw_data.Rdata')
```

### Anàlisi univariant de les variables

**Variables categòriques**

Pel que fa a l'anàlisi descriptiva univariant per a variables categòriques, es creen gràfiques de tipus *pie chart* que representen la part proporcional de cada nivell o categoria sobre el total d'observacions de la variable categòrica així com un gràfic de barres que compta les ocurrències de cada categoria o nivell de la variable. La mateixa informació que mostren aquests dos gràfics es pot representar en una taula de freqüències. 

*COURSE*

```{r, out.width="50%"}
profiling(raw_data$course, 'course', raw_data)
```

El curs amb menys estudiants és el de "Biofuel Production Techno" amb un total de 12 alumnes. Així mateix, el curs amb més estudiants és el de "Nursing".

*DAYTIME_ATTENDANCE*

```{r, out.width="50%"}
profiling(raw_data$daytime_attendance, 'daytime_attendance', raw_data)
```

La major part de l'assistència es concentra en la franja horària del matí.

\pagebreak

*NATIONALITY*

```{r, out.width="50%"}
profiling(raw_data$nationality, 'nationality', raw_data)
```

El 97.5% dels alumnes són portuguesos. Les altres 20 nacionalitats es distribueixen entre el 2.5% restant dels individus.

*OCCUPATION_MOTHER*

```{r, out.width="50%"}
profiling(raw_data$occupation_mother, 'occupation_mother', raw_data)
```

Les ocupacions de les mares més destacades són treballadora no qualificada (35.5%) i personal administratiu (18.4%).

*OCCUPATION_FATHER*

```{r, out.width="50%"}
profiling(raw_data$occupation_father, 'occupation_father', raw_data)
```

La feina més representativa dels pares és treballador no qualificat, seguida dels llocs de treball a la construcció.

*SPECIAL_NEEDS*

```{r, out.width="50%"}
profiling(raw_data$special_needs, 'special_needs', raw_data)
```

El 98.9% dels alumnes no tenen necessitats especials.

*GENDER*

```{r, out.width="50%"}
profiling(raw_data$gender, 'gender', raw_data)
```

Aproximadament el 65% dels individus s'identifiquen com a dona.

\pagebreak

*SCHOLARSHIP*

```{r, out.width="50%"}
profiling(raw_data$scholarship, 'scholarship', raw_data)
```

Tres quartes parts dels alumnes no reben cap mena d'ajuda econòmica.

*TARGET*

```{r, out.width="50%"}
profiling(raw_data$target, 'target', raw_data)
```

La meitat dels enquestats són graduats, el 32% ha abandonat els estudis i quasi el 18% són persones que han reprès els estudis.

*PREVIOUS_QUALIFICATION*

```{r, out.width="50%"}
profiling(raw_data$previous_qualification, 'previous_qualification', raw_data)
```

El 84% dels estudiants tenen l'Educació Secundària Obligatòria.

**Variables numèriques**

Per a l'anàlisi univariant de variables numèriques s'utilitza un histograma per analitzar visualment els valors que pren aquesta variable. També es fa un resum (i.e. *summary*) de la variable que permet conèixer, entre altres coses, quina és la mitjana, la mediana, el valor màxim i el valor mínim que pren.

\pagebreak

*AGE*

```{r, out.width="60%"}
profiling(raw_data$age, 'age', raw_data)
```

La variable edat es comprèn dins un interval que va dels 17 als 70 anys amb ambdós inclosos. No obstant això, la població es distribueix principalment al voltant dels 20 anys.

*GRADES_SEM_1*

```{r, out.width="60%"}
profiling(raw_data$grades_sem_1, 'grades_sem_1', raw_data)
```

Les notes del primer semestre es reparteix en gran manera entre 10 i 14.

\pagebreak

*NO_EVAL_SEM_1*

```{r, out.width="60%"}
profiling(raw_data$no_eval_sem_1, 'no_eval_sem_1', raw_data)
```

Majoritàriament, no hi ha unitats curriculars no avaluades el primer semestre.

*GRADES_SEM_2*

```{r, out.width="60%"}
profiling(raw_data$grades_sem_2, 'grades_sem_2', raw_data)
```

Les notes del segon semestre es reparteix en gran manera entre 10 i 14.

\pagebreak

*NO_EVAL_SEM_2*

```{r, out.width="60%"}
profiling(raw_data$no_eval_sem_2, 'no_eval_sem_2', raw_data)
```

Majoritàriament, no hi ha unitats no avaluades el segon semestre.

*UNEMPLOYMENT_RATE*

```{r, out.width="60%"}
profiling(raw_data$unemployment_rate, 'unemployment_rate', raw_data)
```

El valor més baix que pren la taxa d'atur és 7.6% i el més alt, 16.2%.

\pagebreak

*INFLATION_RATE*

```{r, out.width="60%"}
profiling(raw_data$inflation_rate, 'inflation_rate', raw_data)
```

La màxima taxa d'inflació és del 3.7%.

*GDP*

```{r, out.width="60%"}
profiling(raw_data$gdp, 'gdp', raw_data)
```

El PIB oscil·la entre -4 i 3.5.

\pagebreak

### Anàlisi bivariant

Per a l'anàlisi bivariant es miren les combinacions més interessants (i que més sentit té fer) de dues variables. 

**Dues variables numèriques**

A l'hora d'analitzar conjuntament dues variables numèriques, s'utilitza un *scatterplot* on cada variable està representada en un dels dos eixos.

*AGE* i *GRADES_SEM_1*

```{r, out.width="60%"}
ggplot(data = raw_data, aes(x = age, y = grades_sem_1, color = grades_sem_1)) +
  geom_jitter()  +
  scale_color_gradient(low = "lightblue", high = "orange") +
  theme_minimal()
```

Es veu que no hi ha diferències significatives en la nota del primer semestre segons l'edat. Però en les edats més avançades, les notes poden no arribar a ser tan altes.

*AGE* i *GRADES_SEM_2*

```{r, out.width="60%"}
ggplot(data = raw_data, aes(x = age, y = grades_sem_2, color = grades_sem_2)) +
  geom_jitter()  +
  scale_color_gradient(low = "lightblue", high = "orange") +
  theme_minimal()
```

S'observa el mateix que en el gràfic anterior amb les notes del primer semestre.

\pagebreak

*AGE* i *NO_EVAL_SEM_1*

```{r, out.width="60%"}
ggplot(data = raw_data, aes(x = age, y = no_eval_sem_1, color = no_eval_sem_1)) +
  geom_jitter()  +
  scale_color_gradient(low = "lightblue", high = "orange") +
  theme_minimal()
```

Segons l'edat, no sembla que hi hagi diferències en les unitats no avaluades.

*AGE* i *NO_EVAL_SEM_2*

```{r, out.width="60%"}
ggplot(data = raw_data, aes(x = age, y = no_eval_sem_2, color = no_eval_sem_2)) +
  geom_jitter()  +
  scale_color_gradient(low = "lightblue", high = "orange") +
  theme_minimal()
```

Ocorre el mateix que en les unitats no avaluades del primer semestre, l'edat no sembla ser significativa.

\pagebreak

*GRADES_SEM_1* i *NO_EVAL_SEM_1*

```{r, out.width="60%"}
ggplot(data = raw_data, aes(x = grades_sem_1, y = no_eval_sem_1, color = no_eval_sem_1)) +
  geom_jitter()  +
  scale_color_gradient(low = "lightblue", high = "orange") +
  theme_minimal()
```

Si es mira el gràfic, no s'observa gaire correlació entre les notes i les unitats no avaluades del primer semestre.

*GRADES_SEM_2* i *NO_EVAL_SEM_2*

```{r, out.width="60%"}
ggplot(data = raw_data, aes(x = grades_sem_2, y = no_eval_sem_2, color = no_eval_sem_2)) +
  geom_jitter()  +
  scale_color_gradient(low = "lightblue", high = "orange") +
  theme_minimal()
```

No s'observa gaire correlació entre les notes i les unitats no avaluades del segon semestre.

**Dues variables categòriques**

Quan hi ha dues variables categòriques, s'utilitza un gràfic de barres per representar les ocurrències d'una de les variables separant entre nivells o categories de l'altra variable.

*NATIONALITY* i *DAYTIME_ATTENDANCE*

Per a aquesta primera anàlisi, en ser la majoria dels alumnes de nacionalitat portuguesa se separen el nombre de casos de persones portugueses respecte als altres casos, ja que si no, no es pot apreciar bé en el gràfic com es distribueixen els casos dels individus no portuguesos.

```{r, out.width="50%"}
ggplot(data = raw_data[raw_data$nationality == "Portuguese" | raw_data$nationality == "Unknown",], aes(x = nationality, fill = daytime_attendance)) +
    geom_bar(position = "dodge") +  scale_fill_manual(values= c("lightblue","purple", "orange")) + theme_minimal() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5))

ggplot(data = raw_data[raw_data$nationality != "Portuguese" & raw_data$nationality != "Unknown",], aes(x = nationality, fill = daytime_attendance)) +
    geom_bar(position = "dodge") +  scale_fill_manual(values= c("lightblue","purple", "orange")) + theme_minimal() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5))
```

Pel cas de persones portugueses, hi ha major assistència durant el matí. Passa el mateix amb els casos de les altres nacionalitats.

*SPECIAL_NEEDS* i *DAYTIME_ATTENDANCE*

```{r, out.width="60%"}
ggplot(data = raw_data, aes(x = special_needs, fill = daytime_attendance)) +
    geom_bar(position = "dodge") +  scale_fill_manual(values= c("lightblue","purple")) + theme_minimal()
```

Els individus que no tenen necessitats especials assisteixen majoritàriament al matí, mentre que els que sí que tenen necessitats especials, només assisteixen al matí.

\pagebreak

*GENDER* i *DAYTIME_ATTENDANCE*

```{r, out.width="60%"}
ggplot(data = raw_data, aes(x = gender, fill = daytime_attendance)) +
    geom_bar(position = "dodge") +  scale_fill_manual(values= c("lightblue","purple")) + theme_minimal()
```

Independentment del gènere, la majoria va a classe en horari de matí.

*SCHOLARSHIP* i *DAYTIME_ATTENDANCE*

```{r, out.width="60%"}
ggplot(data = raw_data, aes(x = scholarship, fill = daytime_attendance)) +
    geom_bar(position = "dodge") +  scale_fill_manual(values= c("lightblue","purple")) + theme_minimal()
```

La majoria de les persones van de matins, sense importar si tenen beca o no.

*PREVIOUS_QUALIFICATION* i *DAYTIME_ATTENDANCE*

Com que la major part dels individus tenen "Secondary education" com a qualificació prèvia, s'han separat aquests casos respecte als altres per tal de poder observar amb millor precisió com es distribueixen.

```{r, out.width="50%"}
ggplot(data = raw_data[raw_data$previous_qualification=="Secondary education",], aes(x = previous_qualification, fill = daytime_attendance)) +
    geom_bar(position = "dodge") +  scale_fill_manual(values= c("lightblue","purple", "orange")) + theme_minimal() 

ggplot(data = raw_data[raw_data$previous_qualification!="Secondary education",], aes(x = previous_qualification, fill = daytime_attendance)) +
    geom_bar(position = "dodge") +  scale_fill_manual(values= c("lightblue","purple", "orange")) + theme_minimal() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5))
```

Sembla que independentment de la qualificació prèvia, els individus assisteixen durant el matí.

*TARGET* i *DAYTIME_ATTENDANCE*

```{r, out.width="60%"}
ggplot(data = raw_data, aes(x = target, fill = daytime_attendance)) +
    geom_bar(position = "dodge") +  scale_fill_manual(values= c("lightblue","purple")) + theme_minimal()
```

Independentment de si van acabar els estudis, els van abandonar o els van continuar més tard, hi ha una tendència a anar al matí a classes.

*NATIONALITY* i *SPECIAL_NEEDS*

```{r, out.width="50%"}
ggplot(data = raw_data[raw_data$nationality == "Portuguese" | raw_data$nationality == "Unknown",], aes(x = nationality, fill = special_needs)) +
    geom_bar(position = "dodge") +  scale_fill_manual(values= c("lightblue","purple", "orange")) + theme_minimal()


ggplot(data = raw_data[raw_data$nationality != "Portuguese" & raw_data$nationality != "Unknown",], aes(x = nationality, fill = special_needs)) +
    geom_bar(position = "dodge") +  scale_fill_manual(values= c("lightblue","purple", "orange")) + theme_minimal() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5))
```

Es pot observar que la majoria d'estudiants de nacionalitat portuguesa no tenen necessitats especials. Per a les altres nacionalitats, no es pot saber significativament la probabilitat de tenir necessitats especials, ja que la mida de la mostra és molt petita, però sembla que no tenen necessitats especials.

*NATIONALITY* i *GENDER*

```{r, out.width="50%"}
ggplot(data = raw_data[raw_data$nationality == "Portuguese" | raw_data$nationality == "Unknown",], aes(x = nationality, fill = gender)) +
    geom_bar(position = "dodge") +  scale_fill_manual(values= c("lightblue","purple", "orange")) + theme_minimal()

ggplot(data = raw_data[raw_data$nationality != "Portuguese" & raw_data$nationality != "Unknown",], aes(x = nationality, fill = gender)) +
    geom_bar(position = "dodge") +  scale_fill_manual(values= c("lightblue","purple", "orange")) + theme_minimal() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5))
```

S'observa més tendència a ser estudiant dona que home tant en la nacionalitat portuguesa com en les altres.

*NATIONALITY* i *SCHOLARSHIP*

```{r, out.width="50%"}
ggplot(data = raw_data[raw_data$nationality == "Portuguese" | raw_data$nationality == "Unknown",], aes(x = nationality, fill = scholarship)) +
    geom_bar(position = "dodge") +  scale_fill_manual(values= c("lightblue","purple", "orange")) + theme_minimal()

ggplot(data = raw_data[raw_data$nationality != "Portuguese" & raw_data$nationality != "Unknown",], aes(x = nationality, fill = scholarship)) +
    geom_bar(position = "dodge") +  scale_fill_manual(values= c("lightblue","purple", "orange")) + theme_minimal() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5))
```

Per a les persones portugueses, la probabilitat de tenir beca és aproximadament un quart. Pels casos de nacionalitat desconeguda s'observa una tendència similar.

*NATIONALITY* i *TARGET*

```{r, out.width="50%"}
ggplot(data = raw_data[raw_data$nationality == "Portuguese" | raw_data$nationality == "Unknown",], aes(x = nationality, fill = target)) +
    geom_bar(position = "dodge") +  scale_fill_manual(values= c("lightblue", "purple", "orange", "red")) + theme_minimal()

ggplot(data = raw_data[raw_data$nationality != "Portuguese" & raw_data$nationality != "Unknown",], aes(x = nationality, fill = target)) +
    geom_bar(position = "dodge") +  scale_fill_manual(values= c("lightblue", "purple", "orange", "red")) + theme_minimal() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5))
```

La probabilitat de graduar-se en persones portugueses és més gran que la de deixar la carrera. Ocorre una tendència similar amb les altres nacionalitats.

*SPECIAL_NEEDS* i *GENDER*

```{r, out.width="60%"}
ggplot(data = raw_data, aes(x = special_needs, fill = gender)) +
    geom_bar(position = "dodge") +  scale_fill_manual(values= c("lightblue","purple")) + theme_minimal()
```

El gènere no sembla rellevant respecte de tenir necessitats especials o no.

*SPECIAL_NEEDS* i *SCHOLARSHIP*

```{r, out.width="60%"}
ggplot(data = raw_data, aes(x = special_needs, fill = scholarship)) +
    geom_bar(position = "dodge") +  scale_fill_manual(values= c("lightblue","purple")) + theme_minimal()
```

Sembla que en tots els casos, tenint o no necessitats especials, la probabilitat de no rebre una beca és més gran que la probabilitat que la concedeixin.

\pagebreak

*TARGET* i *SPECIAL_NEEDS*

```{r, out.width="60%"}
ggplot(data = raw_data, aes(x = target, fill = special_needs)) +
    geom_bar(position = "dodge") +  scale_fill_manual(values= c("lightblue","purple")) + theme_minimal()
```

Per a les persones amb necessitats especials s'observa la mateixa tendència que sense necessitats especials, és més probable graduar-se que deixar la carrera.

*PREVIOUS_QUALIFICATION* i *GENDER*

```{r, out.width="50%"}
ggplot(data = raw_data[raw_data$previous_qualification=="Secondary education",], aes(x = previous_qualification, fill = gender)) +
    geom_bar(position = "dodge") +  scale_fill_manual(values= c("lightblue","purple", "orange")) + theme_minimal()

ggplot(data = raw_data[raw_data$previous_qualification!="Secondary education",], aes(x = previous_qualification, fill = gender)) +
    geom_bar(position = "dodge") +  scale_fill_manual(values= c("lightblue","purple", "orange")) + theme_minimal() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5))
```

Pel que fa a les persones amb educació secundària com a qualificació prèvia, dos terços són dones.

Si s'observen com es distribueix el gènere en les altres qualificacions prèvies, no ocorre el mateix que per a l'educació secundària. Per exemple, hi ha més persones amb un curs d'especialització tecnològica que són homes que dones. No obstant això, per a aquests casos la mida mostral no és gaire gran.

\pagebreak

*GENDER* i *SCHOLARSHIP*

```{r, out.width="60%"}
ggplot(data = raw_data, aes(x = gender, fill = scholarship)) +
    geom_bar(position = "dodge") +  scale_fill_manual(values= c("lightblue","purple")) + theme_minimal()
```

És més probable no tenir "scholarship" que tenir-ne, tant en el cas dels homes com en el de les dones. Tot i això, és més probable tenir beca en el cas de les dones.

*TARGET* i *GENDER*

```{r, out.width="60%"}
ggplot(data = raw_data, aes(x = target, fill = gender)) +
    geom_bar(position = "dodge") +  scale_fill_manual(values= c("lightblue","purple")) + theme_minimal()
```

Tenint en compte que hi ha més dones que homes inscrits, la probabilitat de deixar la carrera és més alta com a home.

\pagebreak

*PREVIOUS_QUALIFICATION* i *SCHOLARSHIP*

```{r, out.width="50%"}
ggplot(data = raw_data[raw_data$previous_qualification=="Secondary education",], aes(x = previous_qualification, fill = scholarship)) +
    geom_bar(position = "dodge") +  scale_fill_manual(values= c("lightblue","purple", "orange")) + theme_minimal()

ggplot(data = raw_data[raw_data$previous_qualification!="Secondary education",], aes(x = previous_qualification, fill = scholarship)) +
    geom_bar(position = "dodge") +  scale_fill_manual(values= c("lightblue","purple", "orange")) + theme_minimal() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5))
```

Per a la majoria de les qualificacions prèvies, la probabilitat de tenir beca sembla inferior que la de no tenir-ne.

*TARGET* i *SCHOLARSHIP*

```{r, out.width="60%"}
ggplot(data = raw_data, aes(x = target, fill = scholarship)) +
    geom_bar(position = "dodge") +  scale_fill_manual(values= c("lightblue","purple")) + theme_minimal()
```

La majoria de les persones amb beca s'han graduat. Les persones sense beca tenen una probabilitat similar de deixar-ho que de graduar-se, aquesta última sent una mica més alta.

*PREVIOUS_QUALIFICATION* i *TARGET*

```{r, out.width="50%"}
ggplot(data = raw_data[raw_data$previous_qualification=="Secondary education",], aes(x = previous_qualification, fill = target)) +
    geom_bar(position = "dodge") +  scale_fill_manual(values= c("lightblue", "purple", "orange", "red")) + theme_minimal()

ggplot(data = raw_data[raw_data$previous_qualification!="Secondary education",], aes(x = previous_qualification, fill = target)) +
    geom_bar(position = "dodge") +  scale_fill_manual(values= c("lightblue", "purple", "orange", "red")) + theme_minimal() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5))
```

Pels individus que tenen com a qualificació prèvia "Secondary education" tenen més probabilitats de graduar-se. No obstant això, per als altres casos la distribució canvia i, per exemple, si tenen "Basic education 3rd cycle" hi ha aproximadament el doble de probabilitats d'abandonar la carrera que de graduar-se.

*OCCUPATION_MOTHER* i *TARGET*

```{r, out.width="60%"}
ggplot(data = raw_data, aes(x = occupation_mother, fill = target)) +
    geom_bar(position = "dodge") +  scale_fill_manual(values= c("lightblue", "purple", "orange", "red")) + theme_minimal() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5))
```

L'ocupació de la mare no sembla una variable rellevant per a si la persona es gradua o no.

*OCCUPATION_FATHER* i *TARGET*

```{r, out.width="60%"}
ggplot(data = raw_data, aes(x = occupation_father, fill = target)) +
    geom_bar(position = "dodge") +  scale_fill_manual(values= c("lightblue", "purple", "orange", "red")) + theme_minimal() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5))
```

L'ocupació del pare no sembla una variable rellevant per a si la persona es gradua o no.

**Una variable numèrica i una de categòrica**

Quan hi ha una variable numèrica i una variable categòrica es fa l'anàlisi multivariant de la mateixa manera que en el cas anterior. La variable numèrica és representada en l'eix de les X i per cada valor d'aquesta variable es representa en format gràfic de barres les ocurrències de cada categoria o nivell de la variable categòrica.

\pagebreak

*AGE* i *GENDER*

```{r, out.width="60%"}
ggplot(raw_data, aes(x = age, fill = gender)) +
    geom_histogram(color="#e9ecef", alpha=1, position = 'dodge', binwidth = 2) +
    scale_fill_manual(values = c("lightblue", "purple", "orange")) 
```

Hi ha més tendència a estudiar en edats joves i en dones. A partir dels 25 anys aproximadament, hi ha un percentatge similar de dones que d'homes que estudien.

*AGE* i *SCHOLARSHIP*

```{r, out.width="60%"}
ggplot(raw_data, aes(x = age, fill = scholarship)) +
    geom_histogram(color="#e9ecef", alpha=1, position = 'dodge', binwidth = 2) +
    scale_fill_manual(values = c("lightblue", "purple", "orange")) 
```

Les beques es concedeixen en edats més joves.

\pagebreak

*AGE* i *SPECIAL_NEEDS*

```{r, out.width="60%"}
ggplot(raw_data, aes(x = age, fill = special_needs)) +
    geom_histogram(color="#e9ecef", alpha=1, position = 'dodge', binwidth = 2) +
    scale_fill_manual(values = c("lightblue", "purple", "orange")) 
```

Pel que fa a les necessitats especials, no sembla que estigui correlacionat amb l'edat.

*AGE* i *DAYTIME_ATTENDANCE*

```{r, out.width="60%"}
ggplot(raw_data, aes(x = age, fill = daytime_attendance)) +
    geom_histogram(color="#e9ecef", alpha=1, position = 'dodge', binwidth = 2) +
    scale_fill_manual(values = c("lightblue", "purple", "orange")) 
```

Amb l'edat, incrementa el percentatge d'assistència a les tardes. No obstant això, continua dominant l'assistència al matí en tots els grups d'edats.

\pagebreak

*AGE* i *TARGET*

```{r, out.width="60%"}
ggplot(raw_data, aes(x = age, fill = target)) +
    geom_histogram(color="#e9ecef", alpha=1, position = 'dodge', binwidth = 2) +
    scale_fill_manual(values = c("lightblue", "purple", "orange")) 
```

A mesura que avança l'edat, incrementa la probabilitat relativa a deixar la carrera.

*GRADES_SEM_1* i *GENDER*

```{r, out.width="60%"}
ggplot(raw_data, aes(x = grades_sem_1, fill = gender)) +
    geom_histogram(color="#e9ecef", alpha=1, position = 'dodge', binwidth = 2) +
    scale_fill_manual(values = c("lightblue", "purple", "orange"))
```

Les notes del primer semestre semblen distribuir-se igualment entre els dos gèneres. Sabent que el 0 significa no presentat s'observa que els homes tenen més tendència a no presentar-se que les dones, tenint en compte que hi ha més dones que homes.

\pagebreak

*GRADES_SEM_1* i *SCHOLARSHIP*

```{r, out.width="60%"}
ggplot(raw_data, aes(x = grades_sem_1, fill = scholarship)) +
    geom_histogram(color="#e9ecef", alpha=1, position = 'dodge', binwidth = 2) +
    scale_fill_manual(values = c("lightblue", "purple", "orange"))
```

Hi ha correlació entre treure notes més altes i tenir una "scholarship". Si no es té beca és més probable no presentar-se.

*GRADES_SEM_1* i *DAYTIME_ATTENDANCE*

```{r, out.width="60%"}
ggplot(raw_data, aes(x = grades_sem_1, fill = daytime_attendance)) +
    geom_histogram(color="#e9ecef", alpha=1, position = 'dodge', binwidth = 2) +
    scale_fill_manual(values = c("lightblue", "purple", "orange"))
```

Les persones que assisteixen a classes de tarda tenen una mitjana de notes en el primer semestre més baixa que les persones que van a classes al matí.

Referent a les notes del segon semestre, es repliquen els mateixos patrons que per a les notes del primer.

\pagebreak

*GRADES_SEM_2* i *GENDER*

```{r, out.width="59%"}
ggplot(raw_data, aes(x = grades_sem_2, fill = gender)) +
    geom_histogram(color="#e9ecef", alpha=1, position = 'dodge', binwidth = 2) +
    scale_fill_manual(values = c("lightblue", "purple", "orange"))
```

*GRADES_SEM_2* i *SCHOLARSHIP*

```{r, out.width="59%"}
ggplot(raw_data, aes(x = grades_sem_2, fill = scholarship)) +
    geom_histogram(color="#e9ecef", alpha=1, position = 'dodge', binwidth = 2) +
    scale_fill_manual(values = c("lightblue", "purple", "orange"))
```

*GRADES_SEM_2* i *DAYTIME_ATTENDANCE*

```{r, out.width="59%"}
ggplot(raw_data, aes(x = grades_sem_2, fill = daytime_attendance)) +
    geom_histogram(color="#e9ecef", alpha=1, position = 'dodge', binwidth = 2) +
    scale_fill_manual(values = c("lightblue", "purple", "orange"))
```

\pagebreak

## Preprocessing

En la primera part del preprocessing s'utilitzaran diferents mètodes per detectar outliers univariants i multivariants. En la segona part es tractaran els valors faltants de les variables categòriques i numèriques. L'objectiu és netejar la base de dades per poder garantir que les següents anàlisis siguin acurades.

```{r, echo = FALSE}
library(assertr)
library(tidyverse)
library(magrittr)
```

```{r, echo = FALSE}
# Carregar les dades raw_data
load("raw_data.Rdata")
data_nona <- na.omit(raw_data)
```

### Detecció d'outliers

Es duu a terme una anàlisi per detectar outliers tant univariant com multivariant, ja que els valors atípics poden afectar potencialment a l'estimació dels paràmetres i a les conclusions extretes de l'informe. 

**Outliers multivariants**

Per a fer la detecció d'outliers multivariants s'utilitzen les dades amb només variables numèriques i sense valors nuls, pel fet que es necessiten aquest tipus de dades per a dur a terme el mètode escollit: Distància de Mahalanobis. Aquesta mesura serveix per mesurar la distància entre dos vectors, on cada vector és una observació (individu). La distància de Mahalanobis es basa en la distància euclidiana i permet identificar combinacions atípiques de diverses variables.

````{r, echo = FALSE}
nums <- unlist(lapply(data_nona, is.numeric), use.names = FALSE)  
data_num_nona <- data_nona[ , nums]
# Mahalanobis distance for each row of data frame
data_num_nona['mahala'] <- maha_dist(data_num_nona)
# Critical values for eight degrees of freedom of chi square 
chiq <- qchisq(0.99, 8) 
# > 18.47531
# data_num_nona[data_num_nona$mahala > chiq, ]
dim <- dim(data_num_nona[data_num_nona$mahala > chiq, ])
````

El resultat de l'anàlisi d'outliers multivariant és que hi ha `r dim[1]` files que en contenen algun. Com no es pot reconèixer quines són les variables d'aquestes files que provoquen el valor atípic, es decideix que les dades i files es queden tal com estan perquè convertir les `r dim[1]` files és una gran pèrdua d'informació i podríem incórrer en errors en les conclusions.

**Outliers univariants de les variables numèriques**

- *VARIABLES 'gdp', 'inflation_rate' I 'unemployment_rate'*

````{r, echo = FALSE}
rw <- raw_data
# hist(rw$gdp)
# hist(rw$inflation_rate)
# hist(rw$unemployment_rate)
````

Aquestes tres variables mostren dades macroeconòmiques dels anys en què van estudiar els alumnes. Com que la recollida de dades es va fer en deu anys, els valors s'han d'agrupar en 10 blocs corresponents als anys. No hi ha cap valor que quedi fora d'aquests blocs, per tant, es pot dir que no hi ha valors atípics.

- VARIABLE 'age'

````{r, echo = FALSE}
# summary(rw$age)
# hist(rw$age)
# boxplot(rw$age, 
#         main = "AGE",
#         boxwex = 0.5,col="blue")
````

La variable de l'edat segueix una distribució exponencial. Es poden observar alguns valors atípics, però aquests no responen a errors en la recollida de dades, sinó a casos d'estudiants d'edat més avançada. No hi ha indicis que es tracti de cap error, ja que el valor màxim és de 70, una edat poc comuna però factible per a un estudiant. Així doncs, no és necessari eliminar aquests valors.

- VARIABLES 'grades_sem_1' I 'grades_sem_2'

````{r, echo = FALSE}
# summary(rw$grades_sem_1)
# summary(rw$grades_sem_2)
````

Aquestes dues variables indiquen les qualificacions dels alumnes. En el sistema universitari portuguès (on es desenvolupa l'estudi) les assignatures es qualifiquen del 0 al 20. Observant el rang de les dades es pot veure que no hi ha cap outlier.

- VARIABLES 'no_eval_sem_1' I 'no_eval_sem_2'

````{r, echo = FALSE}
# summary(rw$no_eval_sem_1)
# hist(rw$no_eval_sem_1)
# summary(rw$no_eval_sem_2)
# hist(rw$no_eval_sem_2)
````

Aquestes variables indiquen la quantitat de crèdits no avaluats de cada alumne. Mentre el valor sigui inferior al nombre de crèdits matriculats no hi ha indicis que hi hagi outliers.

### Tractament de NA's

El tractament de NA's es duu a terme per variables categòriques i per variables numèriques. Per les variables categòriques es crea una categoria per agrupar els NA's, mentre que per les variables numèriques s'utilitzarà el mètode d'imputació MIMMI.

**NA's en variables categòriques**

Es crea una variable 'Unknown', que serà un nou nivell de les variables factors, que agrupa tots els NA's d'aquestes variables.

````{r, echo = FALSE}
# varCat <- sapply(rw, is.factor)
# varCat <- names(varCat)[varCat == TRUE]
# 
# for (vC in varCat) {
#   rw[, vC] <- as.character(rw[, vC])
#   quienes <- which(is.na(rw[, vC]))
#   rw[quienes, vC] <- "Unknown"
#   rw[, vC] <- as.factor(rw[, vC])
#   print(levels(rw[ ,vC]))
# }
````

**NA's en variables numèriques (MIMMI)**

Per tractar els valors faltants de les variables numèriques es farà servir el mètode Mixed Intelligent Multivariate Missing Imputation (MIMMI). Aquest mètode permet imputar els NA's en bases de dades multivariants.

Per aplicar el mètode de MIMMI a les dades s'ha treballat sobre el codi de Karina Gibert: *Gibert, K. (2014). Mixed intelligent-multivariate missing imputation. International Journal of Computer Mathematics, 91(1), 85-96 Barcelona May 2019*

````{r, echo = FALSE}
# install.packages("StatMatch")
library(cluster)
require(StatMatch)

# assume missings represented with NA
uncompleteVar <- function(vector){any(is.na(vector))}

Mode <- function(x) 
{
  x <- as.factor(x)
  maxV <- which.max(table(x))
  return(levels(x)[maxV])
}
````

Diem que k=3 perquè la població es divideix en 3 categories (Graduate, Dropout, Enrolled).

````{r, echo = FALSE}
# MiMMi <- function(data, priork=-1)
# {
#   # Identify columns without missings
#   colsMiss <- which(sapply(data, uncompleteVar))
#   if(length(colsMiss) == 0){
#     print("Non missing values found")
#     out <- dd
#   } else {
#     K <- dim(data)[2]
#     colsNoMiss <- setdiff(c(1:K), as.vector(colsMiss))
#     
#     #cluster with complete data
#     dissimMatrix <- daisy(data[ , colsNoMiss], metric = "gower", stand = TRUE)
#     distMatrix <- dissimMatrix^2
#     
#     hcdata <- hclust(distMatrix, method = "ward.D2")
#     plot(hcdata)
#     
#     if(priork == -1){
#       nk <- readline("See the dendrogramm and enter a high number of clusters (must be a positive integer). k: ")
#       nk <- as.integer(nk)
#     } else {nk <- priork}
#     
#     partition <- cutree(hcdata, nk)
#     
#     CompleteData <- data
#     # només cal per tenir traça de com s'ha fet la substitució
#     newCol <- K+1
#     CompleteData[ , newCol] <- partition
#     names(CompleteData)[newCol] <- "ClassAux"
#     
#     setOfClasses <- as.numeric(levels(as.factor(partition)))
#     imputationTable <- data.frame(row.names = setOfClasses)
#     p <- 1
#     
#     for(k in colsMiss)
#     {
#       # Files amb valors utils
#       rowsWithFullValues <- !is.na(CompleteData[,k])
#       
#       # Calcular valors d'imputació
#       if(is.numeric(CompleteData[,k]))
#       {
#         imputingValues <- aggregate(CompleteData[rowsWithFullValues,k], by = list(partition[rowsWithFullValues]), FUN = mean)
#       } else {
#         imputingValues <- aggregate(CompleteData[rowsWithFullValues,k], by = list(partition[rowsWithFullValues]), FUN = Mode)
#       }
#       
#       # Impute
#       for(c in setOfClasses)
#       {
#         data[is.na(CompleteData[,k]) & partition == c,k] <- round(imputingValues[c,2],0)
#       }
#       
#       # Imputation Table
#       imputationTable[,p] <- imputingValues[,2]
#       names(imputationTable)[p] <- names(data)[k]
#       p <- p+1
#     }
#     
#     rownames(imputationTable) <- paste0("c", 1:nk)
#     out <- new.env()
#     out$imputedData <-data
#     out$imputation <- imputationTable
#   }
#   return(out)
# }
# 
# # run MIMMI
# dimpute <-MiMMi(rw)
# 
# # table of imputation values used
# dimpute$imputation
# 
# # imputed dataset
# prepro_data <- dimpute$imputedData
````

````{r, echo = FALSE}
# Es guarda dataframe de dades després del preprocessing
# save(prepro_data, file = 'prepro_data.Rdata')
````

## Anàlisi descriptiva després del preprocessing

```{r}
library(ggplot2)
library(knitr)
library(summarytools)
library(tidyverse)

profiling = function(X, col_name, data){
  if (!(is.numeric(X) || class(X)=="Date")){ 
    freqs = table(as.factor(X), useNA = "no"); 
    proportions = freqs/nrow(data)
    df = data.frame(x = levels(as.factor(X)), y = freqs)
    par(mfrow = c(1,2))
    print(ggplot(df, aes(x = "", y = freqs, fill = x)) + geom_bar(stat = "identity",
    width = 1) + scale_y_continuous(expand = c(0,0)) + coord_polar("y", start = 0) + 
    theme_minimal())
    print(ggplot(df, aes(x = x, y = freqs)) + geom_bar(stat = "identity", color =
    "lightblue", fill = "lightblue") + 
    geom_text(aes(label = x), nudge_y = -5, size = 3) +
    scale_y_continuous(expand = c(0,0), name = "Frequency") + 
    scale_x_discrete(name = col_name) + 
    theme_minimal() +
    theme(axis.text.x = element_blank(), 
          axis.ticks.x = element_blank(), 
          axis.text.y = element_text(size = 10),
          axis.line.x = element_line(color = "black", size = 0.5),
          panel.grid.major.y = element_line(color = "gray", size = 0.2)))
    x = data.frame(X)
    colnames(x) = col_name
    st_options(plain.ascii  = FALSE,  headings = FALSE, footnote = NA, style = 'grid',
               dfSummary.varnumbers = FALSE, dfSummary.valid.col = FALSE, tmp.img.dir  = "img",
               round.digits = 3, dfSummary.silent=TRUE, dfSummary.graph.col= FALSE)
    dfSummary(x) 

   }else{
      print(ggplot(data, aes(x = X)) + geom_bar(col = "lightblue", fill = "lightblue") + theme_minimal())
       taula = descr(X, transpose = TRUE, style = "rmarkdown", justify = "center", 
                 stats = c("N.Valid", "min", "q1", "med", "mean", "sd", "q3", "max", "iqr"))
       rownames(taula) = NULL
       print(taula)
   }
}
```

```{r}
load('prepro_data.Rdata')
```

### Anàlisi univariant de les variables

Per la part de l'anàlisi descriptiva després del preprocessing, en vista que els resultats són molt similars a aquells d'abans del preprocessing, no es farà una anàlisi en profunditat de cada gràfic, sinó que es remetrà a l'anàlisi d'abans del preprocessing per als gràfics que es presenten. A la part d'anàlisi descriptiva bivariant, en canvi, sí que s'estudiaran tots els gràfics.

**Variables categòriques**

S'ha afegit una variable nova, Unknown, que conté les dades faltants. Com que els missings s'han creat artificialment perquè representin només el 5% de la variable, l'addició de la variable Unknown no provoca canvis significatius en la descriptiva.

En les variables categòriques, la diferència més notòria és que les classes amb més percentatge es veuen reduïdes per la variable Unknown.

*COURSE*

```{r, out.width="50%"}
profiling(prepro_data$course, 'course', prepro_data)
```

*DAYTIME_ATTENDANCE*

```{r, out.width="50%"}
profiling(prepro_data$daytime_attendance, 'daytime_attendance', prepro_data)
```

\pagebreak 

*NATIONALITY*

```{r, out.width="50%"}
profiling(prepro_data$nationality, 'nationality', prepro_data)
```

*OCCUPATION_MOTHER*

```{r, out.width="50%"}
profiling(prepro_data$occupation_mother, 'occupation_mother', prepro_data)
```

*OCCUPATION_FATHER*

```{r, out.width="50%"}
profiling(prepro_data$occupation_father, 'occupation_father', prepro_data)
```

\pagebreak

*SPECIAL_NEEDS*

```{r, out.width="50%"}
profiling(prepro_data$special_needs, 'special_needs', prepro_data)
```

*GENDER*

```{r, out.width="50%"}
profiling(prepro_data$gender, 'gender', prepro_data)
```

\pagebreak

*SCHOLARSHIP*

```{r, out.width="50%"}
profiling(prepro_data$scholarship, 'scholarship', prepro_data)
```

*TARGET*

```{r, out.width="50%"}
profiling(prepro_data$target, 'target', prepro_data)
```

\pagebreak

*PREVIOUS_QUALIFICATION*

```{r, out.width="50%"}
profiling(prepro_data$previous_qualification, 'previous_qualification', prepro_data)
```

**Variables numèriques**

En les variables numèriques tampoc s'observen canvis significatius.
El més destacable és que la mediana de la taxa d'inflació ha baixat de 1.4% a 1% i la mitjana del PIB ha variat de 0.003% a 0.011%.

\pagebreak

*AGE*

```{r, out.width="60%"}
profiling(prepro_data$age, 'age', prepro_data)
```

*GRADES_SEM_1*

```{r, out.width="60%"}
profiling(prepro_data$grades_sem_1, 'grades_sem_1', prepro_data)
```

\pagebreak

*NO_EVAL_SEM_1*

```{r, out.width="60%"}
profiling(prepro_data$no_eval_sem_1, 'no_eval_sem_1', prepro_data)
```

*GRADES_SEM_2*

```{r, out.width="60%"}
profiling(prepro_data$grades_sem_2, 'grades_sem_2', prepro_data)
```

\pagebreak

*NO_EVAL_SEM_2*

```{r, out.width="60%"}
profiling(prepro_data$no_eval_sem_2, 'no_eval_sem_2', prepro_data)
```

*UNEMPLOYMENT_RATE*

```{r, out.width="60%"}
profiling(prepro_data$unemployment_rate, 'unemployment_rate', prepro_data)
```

\pagebreak

*INFLATION_RATE*

```{r, out.width="60%"}
profiling(prepro_data$inflation_rate, 'inflation_rate', prepro_data)
```

*GDP*

```{r, out.width="60%"}
profiling(prepro_data$gdp, 'gdp', prepro_data)
```

\pagebreak

### Anàlisi bivariant

**Dues variables numèriques**

*AGE* i *GRADES_SEM_1*

```{r, out.width="60%"}
ggplot(data = prepro_data, aes(x = age, y = grades_sem_1, color = grades_sem_1)) +
  geom_jitter()  +
  scale_color_gradient(low = "lightblue", high = "orange") +
  theme_minimal()
```

En funció de l'edat, s'observa que no hi ha diferències significatives a la nota del primer semestre. És possible que, en entrar en una edat més avançada (dels 50 endavant) hi hagi menys tendència a les notes excel·lents.

*AGE* i *GRADES_SEM_2*

```{r, out.width="60%"}
ggplot(data = prepro_data, aes(x = age, y = grades_sem_2, color = grades_sem_2)) +
  geom_jitter()  +
  scale_color_gradient(low = "lightblue", high = "orange") +
  theme_minimal()
```

Per a les notes del segon semestre, s'observa el mateix que amb les notes del primer.

\pagebreak

*AGE* i *NO_EVAL_SEM_1*

```{r, out.width="60%"}
ggplot(data = prepro_data, aes(x = age, y = no_eval_sem_1, color = no_eval_sem_1)) +
  geom_jitter()  +
  scale_color_gradient(low = "lightblue", high = "orange") +
  theme_minimal()
```

L'edat no sembla significativa respecte al nombre d'unitats no avaluades al primer semestre.

*AGE* i *NO_EVAL_SEM_2*

```{r, out.width="60%"}
ggplot(data = prepro_data, aes(x = age, y = no_eval_sem_2, color = no_eval_sem_2)) +
  geom_jitter()  +
  scale_color_gradient(low = "lightblue", high = "orange") +
  theme_minimal()
```

Igual que pel primer semestre, l'edat no sembla significativa respecte al nombre d'unitats no avaluades al segon semestre.

\pagebreak

*GRADES_SEM_1* i *NO_EVAL_SEM_1*

```{r, out.width="60%"}
ggplot(data = prepro_data, aes(x = grades_sem_1, y = no_eval_sem_1, color = no_eval_sem_1)) +
  geom_jitter()  +
  scale_color_gradient(low = "lightblue", high = "orange") +
  theme_minimal()
```

No sembla haver-hi correlació entre les notes del primer semestre i el nombre d'unitats no avaluades al primer semestre.

*GRADES_SEM_2* i *NO_EVAL_SEM_2*

```{r, out.width="60%"}
ggplot(data = prepro_data, aes(x = grades_sem_2, y = no_eval_sem_2, color = no_eval_sem_2)) +
  geom_jitter()  +
  scale_color_gradient(low = "lightblue", high = "orange") +
  theme_minimal()
```

No sembla haver-hi correlació entre les notes del segon semestre i el nombre d'unitats no avaluades al segon semestre.

**Dues variables categòriques**

*NATIONALITY* i *DAYTIME_ATTENDANCE*

Per fer l'anàlisi de la variable "nationality", se separaren els casos de persones portugueses o de nacionalitat desconeguda respecte dels altres casos, ja que la diferència en nombre de casos per les dues classificacions no permet veure bé les dades de les persones no portugueses.

```{r, out.width="60%"}
ggplot(data = prepro_data[prepro_data$nationality == "Portuguese" | prepro_data$nationality == "Unknown",], aes(x = nationality, fill = daytime_attendance)) +
    geom_bar(position = "dodge") +  scale_fill_manual(values= c("lightblue","purple", "orange")) + theme_minimal() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5))
```

Pel cas de persones portugueses o de nacionalitat desconeguda, s'observa una distribució similar en assistir al matí, a la tarda o no haver-hi dades al respecte.

```{r, out.width="60%"}
ggplot(data = prepro_data[prepro_data$nationality != "Portuguese" & prepro_data$nationality != "Unknown",], aes(x = nationality, fill = daytime_attendance)) +
    geom_bar(position = "dodge") +  scale_fill_manual(values= c("lightblue","purple", "orange")) + theme_minimal() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5))
```

Pel cas de les persones no portugueses, el nombre reduït de casos no permet veure bé la distribució, però la majoria de les persones va al matí, igual que al cas de les persones portugueses o de nacionalitat desconeguda.

\pagebreak

*SPECIAL_NEEDS* i *DAYTIME_ATTENDANCE*

```{r, out.width="60%"}
ggplot(data = prepro_data, aes(x = special_needs, fill = daytime_attendance)) +
    geom_bar(position = "dodge") +  scale_fill_manual(values= c("lightblue","purple", "orange")) + theme_minimal()
```

Sembla que independentment de si es tenen necessitats especials o no, o si no se sap, la distribució d'anar al dia, a la tarda o que no hi hagi dades és la mateixa que abans.

*GENDER* i *DAYTIME_ATTENDANCE*

```{r, out.width="60%"}
ggplot(data = prepro_data, aes(x = gender, fill = daytime_attendance)) +
    geom_bar(position = "dodge") +  scale_fill_manual(values= c("lightblue","purple", "orange")) + theme_minimal()
```

Independentment del gènere, la majoria de les persones van al matí.

\pagebreak

*SCHOLARSHIP* i *DAYTIME_ATTENDANCE*

```{r, out.width="60%"}
ggplot(data = prepro_data, aes(x = scholarship, fill = daytime_attendance)) +
    geom_bar(position = "dodge") +  scale_fill_manual(values= c("lightblue","purple", "orange")) + theme_minimal()
```

Sembla que les persones amb beca van menys a classe a la tarda que les persones sense beca, relativament a la quantitat de persones que hi ha de cada tipus.

*PREVIOUS_QUALIFICATION* i *DAYTIME_ATTENDANCE*

Per l'anàlisi de dades que inclogui la variable de la qualificació prèvia, se separaran els casos de persones amb educació secundària respecte de les altres, per poder fer una visualització millor de les dades.

```{r, out.width="60%"}
ggplot(data = prepro_data[prepro_data$previous_qualification=="Secondary education",], aes(x = previous_qualification, fill = daytime_attendance)) +
    geom_bar(position = "dodge") +  scale_fill_manual(values= c("lightblue","purple", "orange")) + theme_minimal() 
```

La distribució de matí, tarda i sense dades és la mateixa que s'ha anat observant pel cas de l'educació secundària.

```{r, out.width="60%"}
ggplot(data = prepro_data[prepro_data$previous_qualification!="Secondary education",], aes(x = previous_qualification, fill = daytime_attendance)) +
    geom_bar(position = "dodge") +  scale_fill_manual(values= c("lightblue","purple", "orange")) + theme_minimal() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5))
```

Per als altres casos, es pot observar que hi ha grups que tenen més tendència de l'usual a anar a la tarda, com ara les persones amb un grau o aquelles amb educació bàsica de tercer cicle. Això pot ser perquè aquests són grups que tenen més probabilitat de treballar al matí.

*TARGET* i *DAYTIME_ATTENDANCE*

```{r, out.width="60%"}
ggplot(data = prepro_data, aes(x = target, fill = daytime_attendance)) +
    geom_bar(position = "dodge") +  scale_fill_manual(values= c("lightblue","purple", "orange")) + theme_minimal()
```

Les persones que van deixar el grau tenien més tendència a anar a classe a la tarda que les persones que es van graduar. Es pot observar que aproximadament és el doble de tendència.

\pagebreak

*NATIONALITY* i *SPECIAL_NEEDS*

```{r, out.width="60%"}
ggplot(data = prepro_data[prepro_data$nationality == "Portuguese" | prepro_data$nationality == "Unknown",], aes(x = nationality, fill = special_needs)) +
    geom_bar(position = "dodge") +  scale_fill_manual(values= c("lightblue","purple", "orange")) + theme_minimal()
```

Les persones portugueses majoritàriament no tenen necessitats especials, tot i que es pot veure que aproximadament unes 200 persones portugueses de la mostra sí que en tenen. 

```{r, out.width="60%"}
ggplot(data = prepro_data[prepro_data$nationality != "Portuguese" & prepro_data$nationality != "Unknown",], aes(x = nationality, fill = special_needs)) +
    geom_bar(position = "dodge") +  scale_fill_manual(values= c("lightblue","purple", "orange")) + theme_minimal() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5))
```

Per a les altres nacionalitats, no es pot saber significativament la probabilitat de tenir necessitats especials, ja que la mida de la mostra és molt petita. Es pot observar, però, que la majoria d'estudiants de nacionalitat no portuguesa no tenen necessitats especials a la mostra.

\pagebreak

*NATIONALITY* i *GENDER*

```{r, out.width="60%"}
ggplot(data = prepro_data[prepro_data$nationality == "Portuguese" | prepro_data$nationality == "Unknown",], aes(x = nationality, fill = gender)) +
    geom_bar(position = "dodge") +  scale_fill_manual(values= c("lightblue","purple", "orange")) + theme_minimal()
```

Es pot observar que pels casos de nacionalitat portuguesa, aproximadament hi ha el doble de dones que d'homes estudiant. D'una proporció significativa de persones no se sap el gènere. Pels casos de nacionalitat desconeguda, els gèneres estan més igualats, tot i que no del tot.

```{r, out.width="60%"}
ggplot(data = prepro_data[prepro_data$nationality != "Portuguese" & prepro_data$nationality != "Unknown",], aes(x = nationality, fill = gender)) +
    geom_bar(position = "dodge") +  scale_fill_manual(values= c("lightblue","purple", "orange")) + theme_minimal() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5))
```

A les altres nacionalitats també s'observa més tendència a ser estudiant dona que home.

\pagebreak

*NATIONALITY* i *SCHOLARSHIP*

```{r, out.width="60%"}
ggplot(data = prepro_data[prepro_data$nationality == "Portuguese" | prepro_data$nationality == "Unknown",], aes(x = nationality, fill = scholarship)) +
    geom_bar(position = "dodge") +  scale_fill_manual(values= c("lightblue","purple", "orange")) + theme_minimal()
```

Per a les persones portugueses, la probabilitat de tenir beca és aproximadament un quart. Pels casos de nacionalitat desconeguda s'observa una tendència similar.

```{r, out.width="60%"}
ggplot(data = prepro_data[prepro_data$nationality != "Portuguese" & prepro_data$nationality != "Unknown",], aes(x = nationality, fill = scholarship)) +
    geom_bar(position = "dodge") +  scale_fill_manual(values= c("lightblue","purple", "orange")) + theme_minimal() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5))
```

Per a les persones no portugueses, no hi ha prou dades per a extreure conclusions significatives, però s'observa una tendència similar.

\pagebreak

*NATIONALITY* i *TARGET*

```{r, out.width="60%"}
ggplot(data = prepro_data[prepro_data$nationality == "Portuguese" | prepro_data$nationality == "Unknown",], aes(x = nationality, fill = target)) +
    geom_bar(position = "dodge") +  scale_fill_manual(values= c("lightblue", "purple", "orange", "red")) + theme_minimal()
```

La probabilitat de graduar-se en persones portugueses és aproximadament un 140% de la probabilitat de deixar la carrera.

```{r, out.width="60%"}
ggplot(data = prepro_data[prepro_data$nationality != "Portuguese" & prepro_data$nationality != "Unknown",], aes(x = nationality, fill = target)) +
    geom_bar(position = "dodge") +  scale_fill_manual(values= c("lightblue", "purple", "orange", "red")) + theme_minimal() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5))
```

Amb el nombre baix de dades de nacionalitats no portugueses, no es pot saber bé la distribució, però sembla que es replica l'anterior.

\pagebreak

*SPECIAL_NEEDS* i *GENDER*

```{r, out.width="60%"}
ggplot(data = prepro_data, aes(x = special_needs, fill = gender)) +
    geom_bar(position = "dodge") +  scale_fill_manual(values= c("lightblue","purple", "orange")) + theme_minimal()
```

El gènere no sembla rellevant respecte de tenir necessitats especials o no.

*SPECIAL_NEEDS* i *SCHOLARSHIP*

Per als gràfics, observant el fet de tenir necessitats especials o no junt amb tenir scholarship o no, se separaren la categoria de tenir necessitats especials respecte de no tenir-ne o que no se sàpiga per poder visualitzar millor els resultats.

```{r, out.width="60%"}
ggplot(data = prepro_data[prepro_data$special_needs!="Yes",], aes(x = special_needs, fill = scholarship)) +
    geom_bar(position = "dodge") +  scale_fill_manual(values= c("lightblue","purple", "orange")) + theme_minimal()
```

Per les persones sense necessitats especials, la probabilitat de tenir scholarship és aproximadament un quart. Sembla replicar-se per als casos desconeguts. 

```{r, out.width="60%"}
ggplot(data = prepro_data[prepro_data$special_needs=="Yes",], aes(x = special_needs, fill = scholarship)) +
    geom_bar(position = "dodge") +  scale_fill_manual(values= c("lightblue","purple", "orange")) + theme_minimal()
```

Per a les persones amb necessitats especials, la probabilitat de tenir beca sembla més aviat un terç. Tot i això, la mida mostral reduïda implica que el resultat no és significatiu. 

Per a l'anàlisi conjunta de tenir necessitats especials o no i graduar-se o no, se separaren els casos de necessitats especials i els que no, per poder observar millor els resultats.

*SPECIAL_NEEDS* i *TARGET*

```{r, out.width="60%"}
ggplot(data = prepro_data[prepro_data$special_needs!="Yes",], aes(x = special_needs, fill = target)) + geom_bar(position = "dodge") +  scale_fill_manual(values= c("lightblue","purple", "orange", "red")) + theme_minimal()
```

Sense necessitats especials, la probabilitat de graduar-se és aproximadament un 140% de la de deixar la carrera, altre cop. Pel cas de persones que no se sap si tenen necessitats especials o no, sembla que la probabilitat és la mateixa de graduar-se que de deixar-ho. Tot i això, la mida mostral és molt reduïda.

```{r, out.width="60%"}
ggplot(data = prepro_data[prepro_data$special_needs=="Yes",], aes(x = special_needs, fill = target)) + geom_bar(position = "dodge") +  scale_fill_manual(values= c("lightblue","purple", "orange", "red")) + theme_minimal()
```

Per a les persones amb necessitats especials, s'observa la mateixa tendència que sense necessitats especials.

*PREVIOUS_QUALIFICATION* i *GENDER*

Per l'anàlisi de gènere segons qualificació prèvia, se separaran els casos d'educació secundària respecte dels altres per millor visibilitat.

```{r, out.width="60%"}
ggplot(data = prepro_data[prepro_data$previous_qualification=="Secondary education",], aes(x = previous_qualification, fill = gender)) +
    geom_bar(position = "dodge") +  scale_fill_manual(values= c("lightblue","purple", "orange")) + theme_minimal()
```

Les persones amb educació secundària com a qualificació prèvia, dos terços són dones, aproximadament.

```{r, out.width="60%"}
ggplot(data = prepro_data[prepro_data$previous_qualification!="Secondary education",], aes(x = previous_qualification, fill = gender)) +
    geom_bar(position = "dodge") +  scale_fill_manual(values= c("lightblue","purple", "orange")) + theme_minimal() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5))
```

Per a les altres qualificacions prèvies, la distribució de gènere canvia. Per exemple, hi ha més persones amb un curs d'especialització tecnològica que són homes que dones, o amb educació bàsica de tercer cicle. Tot i això, cal tenir en compte que per a aquests casos la mida mostral no és gaire gran.

*GENDER* i *SCHOLARSHIP*

```{r, out.width="60%"}
ggplot(data = prepro_data, aes(x = gender, fill = scholarship)) +
    geom_bar(position = "dodge") +  scale_fill_manual(values= c("lightblue","purple", "orange")) + theme_minimal()
```

La probabilitat de tenir beca com a dona és més alta que com a home, tot i que continua sent més probable no tenir-ne.

\pagebreak

*TARGET* i *GENDER*

```{r, out.width="60%"}
ggplot(data = prepro_data, aes(x = target, fill = gender)) +
    geom_bar(position = "dodge") +  scale_fill_manual(values= c("lightblue","purple", "orange")) + theme_minimal()
```

Si es miren les freqüències relatives a cada gènere, tenint en compte que hi ha més dones que homes inscrits, la probabilitat de deixar la carrera és més alta com a home, tot i que el nombre observat d'homes que l'hagin deixat i de dones sigui similar. 

*PREVIOUS_QUALIFICATION* i *SCHOLARSHIP*

Per l'anàlisi de qualificació prèvia respecte de scholarship, se separaren els casos d'educació secundària respecte dels altres.

```{r, out.width="60%"}
ggplot(data = prepro_data[prepro_data$previous_qualification=="Secondary education",], aes(x = previous_qualification, fill = scholarship)) +
    geom_bar(position = "dodge") +  scale_fill_manual(values= c("lightblue","purple", "orange")) + theme_minimal()
```

Per a persones amb educació secundària, la probabilitat de tenir beca és aproximadament un quart.

```{r, out.width="60%"}
ggplot(data = prepro_data[prepro_data$previous_qualification!="Secondary education",], aes(x = previous_qualification, fill = scholarship)) +
    geom_bar(position = "dodge") +  scale_fill_manual(values= c("lightblue","purple", "orange")) + theme_minimal() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5))
```

Per a la majoria dels altres casos, la probabilitat de tenir beca sembla inferior.

*TARGET* i *SCHOLARSHIP*

```{r, out.width="60%"}
ggplot(data = prepro_data, aes(x = target, fill = scholarship)) +
    geom_bar(position = "dodge") +  scale_fill_manual(values= c("lightblue","purple", "orange")) + theme_minimal()
```

La majoria de persones amb beca s'han graduat, tot i que n'hi ha hagut que ho han deixat. Les persones sense beca tenen una probabilitat similar de deixar-ho que de graduar-se, aquesta última sent una mica més alta.

\pagebreak

*PREVIOUS_QUALIFICATION* i *TARGET*

```{r, out.width="60%"}
ggplot(data = prepro_data[prepro_data$previous_qualification=="Secondary education",], aes(x = previous_qualification, fill = target)) +
    geom_bar(position = "dodge") +  scale_fill_manual(values= c("lightblue", "purple", "orange", "red")) + theme_minimal()
```

Les persones amb educació secundària tenen un terç aproximat de probabilitats de deixar-ho.

```{r, out.width="60%"}
ggplot(data = prepro_data[prepro_data$previous_qualification!="Secondary education",], aes(x = previous_qualification, fill = target)) +
    geom_bar(position = "dodge") +  scale_fill_manual(values= c("lightblue", "purple", "orange", "red")) + theme_minimal() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5))
```

Per als altres grups la distribució és diferent. Hi ha grups amb més probabilitat de deixar-ho que de seguir, alguns de manera preocupant, com ara per a les persones amb educació bàsica de tercer cicle o de segon cicle.

\pagebreak

*OCCUPATION_MOTHER* i *TARGET*

```{r, out.width="60%"}
ggplot(data = prepro_data, aes(x = occupation_mother, fill = target)) +
    geom_bar(position = "dodge") +  scale_fill_manual(values= c("lightblue", "purple", "orange", "red")) + theme_minimal() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5))
```

L'ocupació de la mare no sembla una variable rellevant per a si la persona es gradua o no.

*OCCUPATION_FATHER* i *TARGET*

```{r, out.width="60%"}
ggplot(data = prepro_data, aes(x = occupation_father, fill = target)) +
    geom_bar(position = "dodge") +  scale_fill_manual(values= c("lightblue", "purple", "orange", "red")) + theme_minimal() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5))
```

La del pare tampoc.

\pagebreak

**Una variable numèrica i una de categòrica**

*AGE* i *GENDER*

```{r, out.width="60%"}
ggplot(prepro_data, aes(x = age, fill = gender)) +
    geom_histogram(color="#e9ecef", alpha=1, position = 'dodge', binwidth = 2) +
    scale_fill_manual(values = c("lightblue", "purple", "orange")) 

```

Hi ha més tendència a estudiar a edats joves. Als rangs d'edat més joves, hi ha més dones que homes. A partir, aproximadament, els 25, els dos gèneres estudien de forma similar.

*AGE* i *SCHOLARSHIP*

```{r, out.width="60%"}
ggplot(prepro_data, aes(x = age, fill = scholarship)) +
    geom_histogram(color="#e9ecef", alpha=1, position = 'dodge', binwidth = 2) +
    scale_fill_manual(values = c("lightblue", "purple", "orange")) 
```

Les beques són molt més comunes a les edats més joves.

\pagebreak

*AGE* i *SPECIAL_NEEDS*

```{r, out.width="60%"}
ggplot(prepro_data, aes(x = age, fill = special_needs)) +
    geom_histogram(color="#e9ecef", alpha=1, position = 'dodge', binwidth = 2) +
    scale_fill_manual(values = c("lightblue", "purple", "orange")) 
```

No sembla que hi hagi correlació entre l'edat i tenir necessitats especials.

*AGE* i *DAYTIME_ATTENDANCE*

```{r, out.width="60%"}
ggplot(prepro_data, aes(x = age, fill = daytime_attendance)) +
    geom_histogram(color="#e9ecef", alpha=1, position = 'dodge', binwidth = 2) +
    scale_fill_manual(values = c("lightblue", "purple", "orange")) 
```

S'observa que, amb l'edat, hi ha més tendència a anar a classes de tardes que de matins.

\pagebreak

*AGE* i *TARGET*

```{r, out.width="60%"}
ggplot(prepro_data, aes(x = age, fill = target)) +
    geom_histogram(color="#e9ecef", alpha=1, position = 'dodge', binwidth = 3) +
    scale_fill_manual(values = c("lightblue", "purple", "orange", "red")) 
```

Amb l'edat, incrementa la probabilitat relativa de deixar la carrera i no graduar-se.

*GRADES_SEM_1* i *GENDER*

```{r, out.width="60%"}
ggplot(prepro_data, aes(x = grades_sem_1, fill = gender)) +
    geom_histogram(color="#e9ecef", alpha=1, position = 'dodge', binwidth = 1) +
    scale_fill_manual(values = c("lightblue", "purple", "orange")) 
```

Les notes del primer semestre semblen distribuir-se igualment entre els dos gèneres, tenint les dones una mitjana relativament més alta. Tenint en compte que el 0 significa no presentat, però, s'observa que els homes tenen més tendència a no presentar-se que les dones.

\pagebreak

*GRADES_SEM_1* i *SCHOLARSHIP*

```{r, out.width="60%"}
ggplot(prepro_data, aes(x = grades_sem_1, fill = scholarship)) +
    geom_histogram(color="#e9ecef", alpha=1, position = 'dodge', binwidth = 1) +
    scale_fill_manual(values = c("lightblue", "purple", "orange")) 
```

Hi ha correlació entre treure notes més altes i tenir una beca. Tenint beca també és molt menys probable no presentar-se.

*GRADES_SEM_1* i *DAYTIME_ATTENDANCE*

```{r, out.width="60%"}
ggplot(prepro_data, aes(x = grades_sem_1, fill = daytime_attendance)) +
    geom_histogram(color="#e9ecef", alpha=1, position = 'dodge', binwidth = 1) +
    scale_fill_manual(values = c("lightblue", "purple", "orange")) 
```

Les persones que acudeixen a classe de tardes tenen una mitjana de notes al primer semestre més baixa que les persones que acudeixen a classes al matí.

Es repliquen els mateixos patrons per a les notes del segon semestre que s'observen per a les notes del primer.

\pagebreak

*GRADES_SEM_2* i *GENDER*

```{r, out.width="59%"}
ggplot(prepro_data, aes(x = grades_sem_2, fill = gender)) +
    geom_histogram(color="#e9ecef", alpha=1, position = 'dodge', binwidth = 2) +
    scale_fill_manual(values = c("lightblue", "purple", "orange"))
```

*GRADES_SEM_2* i *SCHOLARSHIP*

```{r, out.width="59%"}
ggplot(prepro_data, aes(x = grades_sem_2, fill = scholarship)) +
    geom_histogram(color="#e9ecef", alpha=1, position = 'dodge', binwidth = 2) +
    scale_fill_manual(values = c("lightblue", "purple", "orange"))
```

*GRADES_SEM_2* i *DAYTIME_ATTENDANCE*

```{r, out.width="59%"}
ggplot(prepro_data, aes(x = grades_sem_2, fill = daytime_attendance)) +
    geom_histogram(color="#e9ecef", alpha=1, position = 'dodge', binwidth = 2) +
    scale_fill_manual(values = c("lightblue", "purple", "orange"))
```

\pagebreak

# Clustering jeràrquic

## Clustering

```{r}
# Instal·lació de paquet si és necessària i carregar les llibreries
```

```{r}
# install.packages("NbClust")
# library(NbClust)
# library('dendextend')
# library(scales)
# library(cluster)
```

```{r}
# Es fa un primer dendrograma amb el mètode de Ward amb la distància de Gower, donat que el k-means no es pot fer perquè hi ha tant variables quantitatives com qualitatives.
```

```{r}
# load("prepro_data.Rdata")
# 
# mydata <- prepro_data
# rm(prepro_data)
# 
# dd <- mydata
# dd <- as.data.frame(lapply(mydata, function(x) if(is.numeric(x)){
#              scale(x, center=TRUE, scale=TRUE)
#           } else x))
# 
# # es calcula la distància de gower:
# dissimMatrix <- daisy(dd, metric = "gower", stand = TRUE)
# 
# distMatrix <- dissimMatrix^2
# 
# h1 <- hclust(distMatrix, method = "ward.D2")
# 
# plot(h1)
```

```{r}
# A primera vista amb el dendrograma ja es veu que el tall òptim són 3 clústers. De totes maneres, es comprova analíticament.
# 
# Coeficient de Silhouette:
# 
# Per calcular el nombre de clústers que s'haurien d'agafar primer es fa amb el coeficient de Silhouette.
```

```{r}
# avg_sil <- c()
# for (k in 2:15) {
#   hc_result <- hclust(distMatrix, method = "complete")
#   clust <- cutree(hc_result, k)
#   sil <- silhouette(clust, distMatrix)
#   avg_sil[k-1] <- mean(sil[,3])
# }
# plot(avg_sil, type = "b", xlab = "Number of clusters", ylab = "Average silhouette width")
```

```{r}
# Es veu que el que té un valor més gran de la mitjana de Silhouette és k = 2, però el pròxim millor és k = 3.
# 
# 2n mètode (només numèriques): Nbclust
```

```{r}
# Objectos <- sapply(dd, class)
# Numeriques <- names(Objectos)[which(Objectos%in%c("numeric"))]
# 
# nb_clustering <- NbClust(dd[,Numeriques], distance = "euclidean", min.nc = 2, max.nc = 10, method = "ward.D", index = "all")
# 
# nb_clustering$Best.nc
```

```{r}
# ******************************************************************* 
# * Among all indices:                                                
# * 1 proposed 2 as the best number of clusters 
# * 9 proposed 3 as the best number of clusters 
# * 5 proposed 4 as the best number of clusters 
# * 1 proposed 5 as the best number of clusters 
# * 2 proposed 7 as the best number of clusters 
# * 2 proposed 10 as the best number of clusters 
# 
#                    ***** Conclusion *****                            
#  
# * According to the majority rule, the best number of clusters is  3 
# ******************************************************************* 
```

```{r}
# Amb NbClust el millor nombre de clústers és 3.
# 
# Es torna a fer el dendrograma.
```

```{r}
# hc <- hclust(daisy(dd, metric = "gower")^2, "ward.D2") # metrica euclidiana sin elevar al quadrado 
# dd = res.PCA 
# dend <- as.dendrogram(hc)
# plot(dend)
```

```{r}
# Amb el dendrograma es confirma que el millor tall (després de k = 2) és k = 3.
```

```{r}
# objecto <- cutree(hc, 3)
# # s'apliquen els resultats a les dades no normalitzades
# mydata$cluster <- objecto
# colors <- c("red", "green", "blue")
# colors_dend <- color_branches(dend, labels = objecto, k = 3, col = colors)
# plot(colors_dend)
```

```{r}
# Es guarden les dades preprocessades amb els clústers fets.
```

```{r}
# save(mydata, file = 'data_clust.Rdata')
```

La base de dades emprada té tant variables qualitatives com quantitatives, llavors s'ha decidit analitzar-les mitjançant mètriques mixtes. Per poder fer el clustering es fa servir el mètode de Ward, que és un mètode jeràrquic ascendent. Pel mateix motiu, per computar-lo s'usa la dissimilitud de Gower al quadrat.

$$s(i,i') = \frac{\sum_{k=1}^K w_k(i,i’) s_k(i,i’)}{\sum_{k=1}^K w_k(i,i’)}$$

$$d_{ii'}^2 = 1 - s(i,i')$$

$$w_k(i,i') = \left\{\begin{matrix}
0 & if \ (x_{ik}=NA) \ or \ if \ (x_{i'k}=NA) \\
0 & if \ (X_k \ is \ binary) \ and \ (x_{ik}=FALSE) \ and \  (x_{i'k}=FALSE)\\
1 &  \ otherwise \\
\end{matrix}\right.
$$

$$s_k(i,i') = \left\{\begin{matrix}
0 & if \ X_k \ numeric \\
0 & if \ (X_k = qualitative) \ and \ (x_{ik} = (x_{i'k}) \\
1 &  if \ (X_k = qualitative) \ and \ (x_{ik} \neq (x_{i'k}) \\
\end{matrix}\right.$$

on $R_k$ és el rang de la k-èssima variable.

Una vegada s'ha calculat la distància, es procedeix a emprar el mètode de Ward per agrupar les dades de manera homogènia. El mètode de Ward pretén trobar a cada etapa dos clústers que proporcionen el menor increment de la suma total d'errors.

Amb la distància calculada s'aplica Ward a les dades i es fa un primer dendrograma.

![]("Imagen1.png")

En aquest dendrograma ja es veu que el nombre òptim de grups per les dades és k = 3. Encara així es comprova analíticament.

Primer, per les variables categòriques i numèriques, es fa servir el coeficient de Silhouette, que diu que k òptima és 2, encara que 3 també és una bona elecció.

![]("Imagen2.png")

Per totes les variables numèriques, s'usa la funció de R 'nbclust' que indica el nombre de clústers òptim per diferents mètodes:

* Among all indices:

* 1 proposed 2 as the best number of clusters

* 9 proposed 3 as the best number of clusters

* 5 proposed 4 as the best number of clusters

* 1 proposed 5 as the best number of clusters

* 2 proposed 7 as the best number of clusters

* 2 proposed 10 as the best number of clusters

La majoria dels mètodes proposen k = 3 com a millor partició.

Tenint en compte el primer dendrograma i aquesta informació, es decideix agrupar les dades en 3 grups diferents, per assegurar la seva homogeneïtat.

Es fa un segon clúster per visualitzar millor aquests resultats.

![]("Imagen3.png")

## Profiling dels clusters

```{r}
# Cargamos los datos
```

```{r}
# load("data_clust.Rdata")
```

```{r}
# Definimos las funciones que calculan la significación de las variables mediante el p-valor
```

```{r}
# ValorTestXnum <- function(Xnum,P){
#   #freq dis of fac
#   nk <- as.vector(table(P)); 
#   n <- sum(nk); 
#   #mitjanes x grups
#   xk <- tapply(Xnum,P,mean);
#   #valors test
#   txk <- (xk-mean(Xnum))/(sd(Xnum)*sqrt((n-nk)/(n*nk))); 
#   #p-values
#   pxk <- pt(txk,n-1,lower.tail=F);
#   for(c in 1:length(levels(as.factor(P)))){if (pxk[c]>0.5){pxk[c]<-1-pxk[c]}}
#   return (pxk)
# }
# 
# 
# ValorTestXquali <- function(P,Xquali){
#   taula <- table(P,Xquali);
#   n <- sum(taula); 
#   pk <- apply(taula,1,sum)/n;
#   pj <- apply(taula,2,sum)/n;
#   pf <- taula/(n*pk);
#   pjm <- matrix(data=pj,nrow=dim(pf)[1],ncol=dim(pf)[2], byrow=TRUE);      
#   dpf <- pf - pjm; 
#   dvt <- sqrt(((1-pk)/(n*pk))%*%t(pj*(1-pj))); 
#   zkj <- dpf
#   zkj[dpf!=0]<-dpf[dpf!=0]/dvt[dpf!=0]; 
#   pzkj <- pnorm(zkj,lower.tail=F);
#   for(c in 1:length(levels(as.factor(P)))){for (s in 1:length(levels(Xquali))){if (pzkj[c,s]> 0.5){pzkj[c,s]<-1- pzkj[c,s]}}}
#   return (list(rowpf=pf,vtest=zkj,pval=pzkj))
# }
```

```{r}
# Preparamos los objetos necesarios para las herramientas gráficas
```

```{r}
# #datos sin columna de clústers
# dades <- mydata[,-19]
# 
# #número de variables
# K <- ncol(dades)
# 
# #grupos de los clústers
# P <- mydata[,"cluster"]
# nameP <- "classe"
# 
# #número de clústers
# nc <- length(levels(factor(P)))
# 
# #matriz y vector donde añadiremos los p-valores de cada variable
# pvalk <- matrix(data=0,nrow=nc,ncol=K, dimnames=list(levels(as.factor(P)),names(dades)))
# chis <- c()
# 
# #número de observaciones
# n <- dim(dades)[1]
```

```{r}
# Calculamos los p-valores de las variables categóricas y numéricas
```

```{r}
# # Generamos dos tablas, una para las categóricas y otra para las numéricas
# for(k in 1:K){
#   if (is.numeric(dades[,k])){ 
#     for(s in levels(as.factor(P))) 
#     pvalk[,k]<-ValorTestXnum(dades[,k], P)
#   }else{
#     tab <- table(dades[,k],as.factor(P))
#     chis[k]<-(chisq.test(tab)$p.value)
#   }
# }
# 
# #Añadimos los nombres de variable a las tablas
# names(chis) <- colnames(pvalk)
# # Juntamos las tablas
# pvalorsvars <- colMeans(pvalk)
# pvalorsvars[c(1:9,18)]<- chis[c(1:9,18)]
# 
# #Creamos una tabla que nos indica si es significativa o no
# significativa <- pvalorsvars
# for(i in 1:length(pvalorsvars)){
#   if(pvalorsvars[i]<0.05){significativa[i]<-1}else{significativa[i] <- 0}
# }
```

```{r}
# Tabla de los p-valores de las numéricas
```

```{r}
# pvalk[,10:17]
```

```{r}
# Tabla de los p-valores de las categóricas
```

```{r}
# chis[c(1:9,18)]
```

```{r}
# Tabla que nos dice si son significativas o no
# SIGNIFICATIVA
```

```{r}
# Generación de todos los gráficos de las variables que son significativas
```

```{r}
# for(k in 1:K){
#   if (is.numeric(dades[,k]) && significativa[k]==1){ 
#     print(paste("Anàlisi per classes de la Variable:", names(dades)[k]))
#     barplot(tapply(dades[[k]], P, mean),main=paste("Means of", names(dades)[k], "by", nameP ))
#     abline(h=mean(dades[[k]]))
#     legend(0,mean(dades[[k]]),"global mean",bty="n")
#     print("Estadístics per groups:")
#     for(s in levels(as.factor(P))) {print(summary(dades[P==s,k]))}
#     o<-oneway.test(dades[,k]~P)
#     print(paste("p-valueANOVA:", o$p.value))
#     kw<-kruskal.test(dades[,k]~P)
#     print(paste("p-value Kruskal-Wallis:", kw$p.value))
#     print("p-values ValorsTest: ")
#     print(pvalk[,k])      
#   }else if(!is.numeric(dades[,k]) && significativa[k]==1){
#       #qualitatives
#     
#       print(paste("Variable", names(dades)[k]))
#       table<-table(P,dades[,k])
#       #   print("Cross-table")
#       #   print(table)
#       rowperc<-prop.table(table,1)
#       
#       colperc<-prop.table(table,2)
#       #  print("Distribucions condicionades a files")
#       # print(rowperc)
#       
#       #ojo porque si la variable es true o false la identifica con el tipo Logical i
#       
#       dades[,k]<-as.factor(dades[,k])
#       
#       
#       marg <- table(as.factor(P))/n
#       print(append("Categories=",levels(as.factor(dades[,k]))))
#       
#       #from next plots, select one of them according to your practical case
#       
#       par(mar=c(5, 4, 4, 8), xpd=TRUE)
#       plot(marg,type="l",ylim=c(0,1),main=paste("Prop. of pos & neg by",names(dades)[k]))
#       paleta<-rainbow(length(levels(dades[,k])))
#       for(c in 1:length(levels(dades[,k]))){lines(colperc[,c],col=paleta[c]) }
#       legend("topright", levels(dades[,k]), col=paleta, lty=2, cex=0.6)
#       
#       #condicionades a classes
#       print(append("Categories=",levels(dades[,k])))
#       par(mar=c(5, 4, 4, 8), xpd=TRUE)
#       plot(marg,type="n",ylim=c(0,1),main=paste("Prop. of pos & neg by",names(dades)[k]))
#       paleta<-rainbow(length(levels(dades[,k])))
#       for(c in 1:length(levels(dades[,k]))){lines(rowperc[,c],col=paleta[c]) }
#       legend("topright", levels(dades[,k]), col=paleta, lty=2, cex=0.6)
#       
#       #amb variable en eix d'abcisses
#       marg <-table(dades[,k])/n
#       print(append("Categories=",levels(dades[,k])))
#       par(mar=c(5, 4, 4, 8), xpd=TRUE)
#       plot(marg,type="l",ylim=c(0,1),main=paste("Prop. of pos & neg by",names(dades)[k]), las=3)
#       #x<-plot(marg,type="l",ylim=c(0,1),main=paste("Prop. of pos & neg by",names(dades)[k]), xaxt="n")
#       #text(x=x+.25, y=-1, adj=1, levels(CountryName), xpd=TRUE, srt=25, cex=0.7)
#       paleta<-rainbow(length(levels(as.factor(P))))
#       for(c in 1:length(levels(as.factor(P)))){lines(rowperc[c,],col=paleta[c]) }
#       legend("topright", levels(as.factor(P)), col=paleta, lty=2, cex=0.6)
#       
#       #condicionades a columna 
#       par(mar=c(5, 4, 4, 8), xpd=TRUE)
#       plot(marg,type="n",ylim=c(0,1),main=paste("Prop. of pos & neg by",names(dades)[k]), las=3)
#       paleta<-rainbow(length(levels(as.factor(P))))
#       for(c in 1:length(levels(as.factor(P)))){lines(colperc[c,],col=paleta[c]) }
#       legend("topright", levels(as.factor(P)), col=paleta, lty=2, cex=0.6)
#       
#       table<-table(dades[,k],P)
#       print("Cross Table:")
#       print(table)
#       print("Distribucions condicionades a columnes:")
#       print(colperc)
#       
#       #diagrames de barres adosades
#       par(mar=c(5, 4, 4, 8), xpd=TRUE)
#       barplot(table(dades[,k], as.factor(P)), beside=TRUE,col=paleta)
#       legend("topright",levels(as.factor(dades[,k])),pch=1,cex=0.5, col=paleta)
#       
#       print("Test Chi quadrat: ")
#       print(chisq.test(dades[,k], as.factor(P)))
#       
#       print("valorsTest:")
#       print( ValorTestXquali(P,dades[,k]))
# 
#       # g[k] <- ValorTestXquali(P,dades[,k])
#       #calcular els pvalues de les quali
#     }
#   }#endfor
```

L'objectiu de l'elaboració de perfils és poder diferenciar entre els grups amb la distinció adequada, cosa que significa que cada grup té algunes característiques úniques sobre ell i llavors aquest cúmul és la solució ideal per segmentar els valors.

A continuació es farà una anàlisi gràfica de les variables, tant qualitatives com quantitatives, prenent com a factor els tres grups de clústers. Per tal d'observar quin d'aquests és més significatiu a les dades.

S'estudia el p-valor de les variables numèriques. S'observa quines són significatives amb el nivell de significació establit en $\alpha$ = P(error tipus I) = 0.05.

![]("Imagen4.png")

També s'estudia el p-valor de les variables categòriques per triar les significatives, mitjançant el test chi-quadrat de cadascuna respecte als clústers.

![]("Imagen5.png")

A la següent taula es mostra el valor 1 de les variables considerades com a significatives. Aquestes seran estudiades gràficament com prèviament s'ha esmentat.

![]("Imagen6.png")

S’exclouen de l’anàlisi les següents variables:

- Nationality

- Special_needs

- No_eval_sem_2

- Unemployement_rate

\pagebreak

### Anàlisi gràfica de les variables numèriques

*EDAT*

![]("Imagen7.png")

A aquest gràfic es veu com els clústers 1 i 2 són els més propers a la mitjana, mentre el clúster 3, s'allunya més, el que indica que és el més significatiu per a la variable edat.

*NOTES AL PRIMER SEMESTRE*

![]("Imagen8.png")

Per a la variable que tracta sobre les notes al primer semestre, el clúster més significatiu és el corresponent al grup 1.

\pagebreak

*UNITATS CURRICULARS NO AVALUADES AL PRIMER SEMESTRE*

![]("Imagen9.png")

A aquest gràfic es veu com els tres grups varien molt de la mitjana, és a dir, que tots tres són significatius a aquesta variable.

*NOTES AL SEGON SEMESTRE*

![]("Imagen10.png")

Pel que fa als grups en les qualificacions del segon semestre, coincideix amb el gràfic obtingut en les qualificacions del primer. Per tant, el grup significatiu per a aquest grup és el primer.

\pagebreak

*TAXA D'INFACIÓ*

![]("Imagen11.png")

Els tres clústers es troben quasi a la mateixa altura respecte a la mitjana, són molt semblants, no expliquen la variable significativament.

*PIB*

![]("Imagen12.png")

Observant els valors que prenen, el clúster 2 és el més allunyat de la mitjana, per tant, és el més significatiu. Els altres són molt semblants.

Com a conclusió general, sobre els clústers a les variables numèriques, el clúster 1 és el més significatiu, sent el millor a la meitat de les variables estudiades. A l'altra meitat de les variables els clústers 2 i 3 també destaquen a una variable cadascun.

**Clúster 1**: Destaca en les notes més baixes per als dos semestres i la quantitat més gran d'unitats curriculars suspeses.

**Clúster 2**: Destaca a les notes més altes als dos semestres i el PIB més gran.

**Clúster 3**: Destaca en les edats més grans i el menor nombre d'unitats curriculars suspeses.

### Anàlisi gràfica de les variables categòriques

*GRAU DE L'ESTUDIANT*

![]("Imagen13.png")

![]("Imagen14.png")

El primer gràfic mostra com la majoria de les categories a la variable es distribueixen als grups. Cal destacar la divergència "Animation Multimedia Design","Social service" i "Management", aquestes dues últimes categories sent la modalitat de tarda. Al segon gràfic es veu que el grup 2 explica més quantitat de les dades que no pas el grup 3, que quasi no explica.

\pagebreak

*HORARI DE L'ESTUDIANT*

![]("Imagen15.png")

![]("Imagen16.png")

Als dos gràfics s'observa com els grups 1 i 2 són els que expliquen els estudiants de matins, especialment el grup 2. El grup 3 és el que explica els estudiants de tardes.

\pagebreak

*QUALIFICACIÓ PRÈVIA DE L'ESTUDIANT*

![]("Imagen17.png")

![]("Imagen18.png")

S'observa com els estudiants amb un títol previ de secundària són els que més es mostren en la proporció, seguint la línia de la proporció global als grups, representada amb color negre al primer gràfic.

\pagebreak

*OCUPACIÓ DE LA MARE*

![]("Imagen19.png")

![]("Imagen20.png")

Pel que fa a les categories sobre el treball de les mares, totes les ocupacions segueixen la mateixa proporció als grups menys tres, "Other","Bank" i "Student". Al segon gràfic s'observa que: "Unskilled worker" és la categoria amb més proporció entre totes. El grup dos es caracteritza per tenir el nombre més gran de mares que són professores.

\pagebreak

*OCUPACIÓ DEL PARE*

![]("Imagen21.png")

![]("Imagen22.png")

Per altra banda, a l'ocupació del pare, les categories es distribueixen en els grups segons la línia mitjana. Proporcionalment, el segon grup explica més categories, seguint per les restants al grup 1 i quantitats petites al 3.

\pagebreak

*GÈNERE*

![]("Imagen23.png")

![]("Imagen24.png")

Tractant el gènere dels estudiants, el primer grup acull a quasi el mateix nombre d'homes i dones, igual que el tercer encara que aquest menys. El segon grup destaca en la seva gran proporció de dones.

\pagebreak

*BECA*

![]("Imagen25.png")

![]("Imagen26.png")

Al primer gràfic es veu com totes les categories es distribueixen de la mateixa manera. Al segon gràfic s'observa l'alta proporció d'estudiants amb beca.

\pagebreak

*RESULTAT ACADÈMIC*

![]("Imagen27.png")

![]("Imagen28.png")

Als dos gràfics s'observa com el primer grup està constituït pels estudiants que han deixat d’estudiat. El segon, que és el més gran en proporció format pels graduats i els que continuen estudiant.

\pagebreak

### Conclusió sobre els clústers a les variables numèriques i categòriques

**Clúster 1**: Destaca en les notes més baixes per als dos semestres i la quantitat més gran d’unitats curriculars suspeses. És el grup dels estudiants que deixen els estudis i estudiants sense beca.

**Clúster 2**: Destaca a les notes més altes als dos semestres i el PIB més gran. És el grup dels estudiants graduats, amb beca, majoritàriament dones i estudiants de matins, a més de tenir el nombre més gran de mares professores.

**Clúster 3**: Destaca en les edats més grans i el menor nombre d’unitats curriculars suspeses. És el grup format per estudiants amb horari de tarda. En la mateixa proporció d’estudiants que es graduen, com els que deixen d’estudiar.

\pagebreak

# ACP

```{r, include=FALSE}
data = get(load('prepro_data.Rdata'))
```

S'observa que la base de dades té un total de 8 columnes numèriques. Per tant, l'anàlisi de components principals tindrà 8 components.

```{r}
numeric <- which(sapply(data, is.numeric))
data_numeric <- data[, numeric]
sapply(data_numeric, class)
```

Els resultats de l'anàlisi de components principals sobre les variables numèriques són els següents: 

```{r}
pc1 <- prcomp(data_numeric, scale = TRUE)
# class(pc1)
# attributes(pc1)
pc1
```

Cada component representa una inèrcia concreta. S'explica el percentatge d'inèrcia que representa cada component. 

```{r, echo=FALSE, out.width="70%", fig.align='center'}
inerProj <- pc1$sdev^2
totalIner <- sum(inerProj)
pinerEix <- 100*inerProj/totalIner
barplot(pinerEix, 
        main = "Percentatge del total d'inèrcia en cada component principal",
        xlab = "", names.arg=paste("PC", 1:8),
        ylab = "Percentatge d'inèrcia", ylim = c(0,35))
text(x = seq(0.7, by = 1.12, length = 8), y = pinerEix+1.5, pos = 4,
     paste0(round(pinerEix, 2),"%"), cex = 0.75, srt = 0)
```

Es veu que la primera component representa el 24.32% de la inèrcia, la segona el 19.26%, la tercera el 16.41%, la quarta el 12.6%, la cinquena el 11.73%, la sisena el 8.06%, la setena el 5.09% i, la vuitena el 2.53%. 

Interessa també la inèrcia acumulada: 

```{r, echo=FALSE, out.width="70%", fig.align='center'}
percInerAccum <- 100*cumsum(pc1$sdev[1:dim(data_numeric)[2]]^2)/dim(data_numeric)[2]
# Percentatge de l'acumulat d'inèrcia representat en cada subespai
par(cex.main = 1, cex.lab = 1)
barplot(percInerAccum, 
        main = "Percentatge d'inèrcia acumulada en cada Component Principal",
        xlab = "Nombre de components", names.arg = 1:8,
        ylab = "Percentatge d'inèrcia acumulada",
        ylim = c(0,125))
abline(h = 80, col = 2, lwd = 2)
text(x = seq(0.5, by = 1.12, length = 8), y = percInerAccum,
     paste0(round(percInerAccum, 2),"%"), cex = 0.85, srt = 0, pos = 4)
```

Tenint en compte que la inèrcia equival a la proporció de la variabilitat de les dades, se sap que amb un 80% d'inèrcia, es pot obtenir gairebé tota la informació o variabilitat de la base de dades original. En el gràfic de la inèrcia acumulada es pot veure que amb les 4 primeres components ja s'aconsegueix gairebé el 80% de la inèrcia. Si es pren les 5 primeres components, el total de variabilitat que s'aconsegueix explicar és del 84.32%. Ens quedem amb les components PC1, PC2, PC3, PC4 i PC5.

```{r}
nd = 5 # ens quedem amb les 5 primeres components principals (PC1, PC2, PC3, PC4, PC5)
``` 

```{r, include=FALSE}
dim(pc1$x)
dim(data_numeric)
# Dades als nous eixos de les 5 PCA
Psi = pc1$x[,1:nd]
dim(Psi)
```

```{r}
iden = row.names(data_numeric) # Etiquetes dels individus
etiq = names(data_numeric) # Etiquetes de les variables numèriques
ze = rep(0,length(etiq)) # Caldrà aquest vector pels gràfics de després
```

Es realitza un gràfic de dispersió per a totes les combinacions possibles: 

```{r, out.width="90%"}
# PLOT OF INDIVIDUALS
eje1 <- 1
eje2 <- 2
plot(Psi[,eje1],Psi[,eje2],ylab = "PC2",xlab="PC1",main="Projecció d'observacions entre PC1 i PC2")
text(Psi[,eje1],Psi[,eje2],labels=iden, cex=0.5)
axis(side=1, pos= 0, labels = F, col="cyan")
axis(side=3, pos= 0, labels = F, col="cyan")
axis(side=2, pos= 0, labels = F, col="cyan")
axis(side=4, pos= 0, labels = F, col="cyan")
```

Les observacions es concentren principalment en els valors més petits de les dues components.

```{r}
Phi = cor(data_numeric, Psi)
# View(Phi)
```

```{r}
fm = round(max(abs(Psi[,1]))) 
```

```{r, out.width="90%"}
X <- Phi[, eje1]
Y <- Phi[, eje2]
plot(Psi[, eje1], Psi[, eje2], type = "n", xlim=c(-4,4),ylim=c(-4,4))
axis(side = 1, pos = 0, labels = F)
axis(side = 3, pos = 0, labels = F)
axis(side = 2, pos = 0, labels = F)
axis(side = 4, pos = 0, labels = F)
arrows(ze, ze, X, Y, length = 0.07, col = "blue")
text(X, Y, labels = etiq, col = "darkblue", cex = 0.7)
```

## Projecció de les variables numèriques

```{r, out.width="90%"}
plot(Psi[,eje1],Psi[,eje2],type="n",xlim=c(min(X,0),max(X,0)), ylim=c(-1,1), 
     xlab = "CP1", ylab = "CP2") 
axis(side=1, pos= 0, labels = F)
axis(side=3, pos= 0, labels = F)
axis(side=2, pos= 0, labels = F)
axis(side=4, pos= 0, labels = F)
arrows(ze, ze, X, Y, length = 0.07,col="blue")
text(X,Y,labels=etiq,col="darkblue", cex=0.7)
```

Les variables que representen les notes dels semestres i les variables que fan referència a les unitats no avaluables són les que tenen més variabilitat continguda en la representació dels dues components del biplot. Així mateix, s'observa que l'edat ha contribuït bastant a la component 1, ja que es veu com el vector paral·lel a l'eix de la component 1.

```{r, out.width="95%"}
# Gràfics de projecció de totes les combinacions possibles
par(mfrow=c(1,2), cex.main=0.60, cex.axis=0.65)
for(eje1 in 1:4){
  for(eje2 in (eje1 + 1):5){
    par(cex=1.5)
    plot(Psi[,eje1],Psi[,eje2],
         main="Gràfic de dispersió dels individus",
         xlab=paste0("PC",eje1," (",round(pinerEix[eje1],4),"%)"), 
         ylab=paste0("PC",eje2," (",round(pinerEix[eje2],4),"%)"),
         bty="n", col="yellow", pch=".", cex=3)
    #text(Psi[,eje1],Psi[,eje2],labels=iden, cex=0.5)
    axis(side=1, pos=0, at=seq(-60, 60, by=2), labels = F,col="red")
    axis(side=3, pos=0, at=seq(-60, 60, by=2), labels = F,col="red")
    axis(side=2, pos=0, at=seq(-60, 60, by=2), labels = F,col="red")
    axis(side=4, pos=0, at=seq(-60, 60, by=2), labels = F,col="red")
    
    }
}
```

En el primer gràfic es veu que els individus es concentren en els valors més petits de PC1 i PC2. Passa el mateix quan es mira PC3 amb PC2, PC4 amb PC2 i PC5 amb PC2. Així mateix, els individus es distribueixen bastant uniformement en els darrers dos gràfics (PC5-PC3 i PC5-PC4).

## Projecció de les variables categòriques

Variables categòriques

```{r}
var_categoriques = which(sapply(data, is.factor))
var_categoriques
```

Si en el mateix gràfic s'afegeixen totes les modalitats de totes les variables categòriques, s'obté el següent:

```{r, echo=FALSE}
plot(Psi[,eje1],Psi[,eje2],type="n",xlim=c(-1.6,1.6), ylim=c(-1,1), 
     xlab = "CP1", ylab = "CP2")
axis(side=1, pos= 0, labels = F, col="cyan")
axis(side=3, pos= 0, labels = F, col="cyan")
axis(side=2, pos= 0, labels = F, col="cyan")
axis(side=4, pos= 0, labels = F, col="cyan")
#nominal qualitative variables
dcat<-c(1, 2, 3, 4, 5, 6, 7, 8, 9, 18)
#divide categoricals in several graphs if joint representation saturates
#build a palette with as much colors as qualitative variables 
#colors<-c("blue","red","green","orange","darkgreen")
#alternative
colors<-rainbow(length(var_categoriques))
c<-1
for(k in var_categoriques){
  seguentColor<-colors[c]
  varcat <- as.factor(data[,k])
  fdic1 <- tapply(Psi[,eje1], varcat, mean)
  fdic2 <- tapply(Psi[,eje2], varcat, mean) 
  text(fdic1, fdic2, levels(varcat), col=seguentColor, cex=0.8, font=3)
c<-c+1
}
legend("topright",names(var_categoriques)[dcat],pch=1,col=colors, cex=0.6)
```

Aquest gràfic no es pot interpretar, ja que en tenir tantes modalitats aquestes no es poden distingir.

Es limita el nombre màxim de modalitats a 8 per variable. A més a més, s'escurcen els noms d'algunes modalitats per tal que siguin llegibles al gràfic. Es repeteix aquest procediment per a les següents variables categòriques: course, previous qualification, nationality, occupation mother i occupation father, que són les que tenen més modalitats. 

```{r, include=FALSE}
# course
freq_table_cat = table(data$course)
freq_table_cat = freq_table_cat[order(freq_table_cat)]
freq_table_cat
```

```{r, include=FALSE}
# se seleccionen les modalitats que es volen etiquetar com "Other" (les menys freqüents)
notkeep <- names(freq_table_cat[freq_table_cat < 258])
keep <- names(freq_table_cat)[!names(freq_table_cat) %in% notkeep]
names(keep) <- keep
# recodificar
levels(data$course) <- c(keep, list("Other" = notkeep))
```

```{r, include=FALSE}
levels(data$course) = c("Marketing", "Management (PM)", "Journalism", "Vet Nursing", "Social Service", "Management", "Nursing", "Other")
```

```{r, include=FALSE}
# previous qualification
freq_table_cat = table(data$previous_qualification)
freq_table_cat = freq_table_cat[order(freq_table_cat)]
freq_table_cat
```

```{r, include=FALSE}
# se seleccionen les modalitats que es volen etiquetar com "Other" (les menys freqüents)
notkeep <- names(freq_table_cat[freq_table_cat < 38])
keep <- names(freq_table_cat)[!names(freq_table_cat) %in% notkeep]
names(keep) <- keep
# recodificar
levels(data$previous_qualification) <- c(keep, list("Other" = notkeep))
```

```{r, include=FALSE}
levels(data$previous_qualification) = c("Degree (1st cycle)", "11th year", "Other", "Degree", "Basic (3rd cycle)", "Unknown", "Tech Specialization", "Secondary")
```

```{r, include=FALSE}
# nationality
freq_table_cat = table(data$nationality)
freq_table_cat = freq_table_cat[order(freq_table_cat)]
freq_table_cat
```

```{r, include=FALSE}
# se seleccionen les modalitats que es volen etiquetar com "Other" (les menys freqüents)
notkeep <- names(freq_table_cat[freq_table_cat < 5])
keep <- names(freq_table_cat)[!names(freq_table_cat) %in% notkeep]
names(keep) <- keep
# recodificar
levels(data$nationality) <- c(keep, list("Other" = notkeep))
```

```{r, include=FALSE}
# occupation mother
freq_table_cat = table(data$occupation_mother)
freq_table_cat = freq_table_cat[order(freq_table_cat)]
freq_table_cat
```

```{r, include=FALSE}
# se seleccionen les modalitats que es volen etiquetar com "Other" (les menys freqüents)
notkeep <- names(freq_table_cat[freq_table_cat < 247])
keep <- names(freq_table_cat)[!names(freq_table_cat) %in% notkeep]
names(keep) <- keep
# recodificar
levels(data$occupation_mother) <- c(keep, list("Other" = notkeep))
```

```{r, include=FALSE}
levels(data$occupation_mother) = c("Unknown", "Construction", "Specialist", "Professor", "Safety Worker", "Other", "Admin", "Unskilled")
```

```{r, include=FALSE}
# occupation father
freq_table_cat = table(data$occupation_father)
freq_table_cat = freq_table_cat[order(freq_table_cat)]
freq_table_cat
```

```{r, include=FALSE}
# se seleccionen les modalitats que es volen etiquetar com "Other" (les menys freqüents)
notkeep <- names(freq_table_cat[freq_table_cat < 254])
keep <- names(freq_table_cat)[!names(freq_table_cat) %in% notkeep]
names(keep) <- keep
# recodificar
levels(data$occupation_father) <- c(keep, list("Other" = notkeep))
```

```{r, include=FALSE}
levels(data$occupation_father) = c("Soldier", "Installation", "Admin", "Professor", "Safety Worker", "Construction", "Unskilled", "Other")
```

```{r}
plot(Psi[,eje1],Psi[,eje2],type="n",xlim=c(-1,1), ylim=c(-1,0.5), 
     xlab = "CP1", ylab = "CP2")
axis(side=1, pos= 0, labels = F, col="cyan")
axis(side=3, pos= 0, labels = F, col="cyan")
axis(side=2, pos= 0, labels = F, col="cyan")
axis(side=4, pos= 0, labels = F, col="cyan")
#nominal qualitative variables
dcat<-c(1:9, 18)
#divide categoricals in several graphs if joint representation saturates
#build a palette with as much colors as qualitative variables 
#colors<-c("blue","red","green","orange","darkgreen")
#alternative
colors<-rainbow(length(var_categoriques))
c<-1
for(k in var_categoriques){
  seguentColor<-colors[c]
  varcat <- as.factor(data[,k])
  fdic1 <- tapply(Psi[,eje1], varcat, mean)
  fdic2 <- tapply(Psi[,eje2], varcat, mean) 
  text(fdic1, fdic2, levels(varcat), col=seguentColor, cex=0.8, font=3)
c<-c+1
}
legend("topright",names(var_categoriques)[dcat],pch=1,col=colors, cex=0.6)
```

Es crea un gràfic per a cada variable categòrica:

```{r, out.width="95%"}
col <- rainbow(length(var_categoriques))
c <- 1
for(k in var_categoriques){
  par(cex.main=1, cex.lab=1)
  plot(Psi[,1],Psi[,2],type="n",
    xlab=paste0("PC",1," (",round(pinerEix[1],4),"%)"),
    ylab=paste0("PC",2," (",round(pinerEix[2],4),"%)"),
    xlim=c(-1.5,1.5), ylim=c(-1,1),
    main="Projeccions sobre el pla factorial de variables categòriques")
  axis(side=1, pos=0, at=seq(-70, 70, by=0.5), labels = F, col="black")
  axis(side=2, pos=0, at=seq(-70, 70, by=0.5), labels = F, col="black")
  axis(side=3, pos=0, at=seq(-70, 70, by=0.5), labels = F, col="black")
  axis(side=4, pos=0, at=seq(-70, 70, by=0.5), labels = F, col="black")
  arrows(ze, ze, X, Y, length = 0.05, col=c("aquamarine3","aquamarine4"))
  text(X,Y,labels=etiq,col=c("aquamarine3","aquamarine4"), cex=0.85, font=3)
  
  varcat <- as.factor(data[,k])
  fdic1 <- tapply(Psi[,1], varcat, mean)
  fdic2 <- tapply(Psi[,2], varcat, mean) 
  text(fdic1, fdic2, levels(varcat), col=seguentColor, cex=0.85, font=3)
  
  legend("bottomleft", legend = names(var_categoriques)[c], fill=seguentColor,
         text.font=2, cex=1, ncol=1, bty="n")
  
  c <- c+1
}
```

Per a la variable **course**, es veu que la majoria de les modalitats de la variable es troben molt a prop de l'origen, fet que implica que expliquen les dues components de manera similar però amb una baixa contribució sobre les components. Destaca la modalitat Vet Nursing, que explica la segona component, ja que es troba tot just a sobre de l'eix d'ordenades. Nursing té angles molt similars amb la primera i la segona component, per tant, es pot dir que les expliquen d'igual manera. 

En la variable **daytime_attendance**, es veu que la modalitat Evening sembla explicar totes dues components per igual.

La modalitat Degree de la variable **previous_qualification** explica més la primera component que la segona. Per aquesta variable, la majoria de les modalitats estan molt propers a l'origen. 11th year sembla explicar totes dues components per un igual.

Per a la variable **nationality**, la modalitat Other explica perfectament la segona component, ja que es troba exactament a sobre de l'eix d'ordenades. La modalitat Guinean forma un angle similar amb totes dues components. 
La majoria de les modalitats de la variable **occupation_mother** expliquen totes dues components per igual, però hi tenen una contribució molt baixa, ja que es troben molt properes a l'origen.

El mateix es pot dir per a la variable **occupation_father** excepte per la modalitat Admin, que en trobar-se sobre l'eix d'ordenades i no sobre el de coordenades explica la segona component. 

Pel que fa a les modalitats de la variable **special_needs**, es veu que només la modalitat No es troba sobre l'origen i que Yes i Unknown només expliquen la segona component.

Per a la variable **gender**, Unknown explica la segona component. Female, en tenir un angle similar entre la primera i la segona es pot dir que les explica per igual. 

La modalitat No de la variable **scholarship** explica la primera component a trobar-se just a sobre de l'eix de coordenades. No obstant això, té una contribució molt baixa sobre aquesta component, ja que es troba bastant propera a l'origen.

Per a la variable **target** destaca la modalitat Dropout, la qual té una contribució força elevada sobre totes dues components. Enrolled sembla explicar més la segona component que la primera.

```{r}
# Es guarden les dades amb menys modalitats i noms més curts per utilitzar en les següents parts del treball
# save(data, file="data_post_pca.RData")
```

\pagebreak

# ACM

```{r, include=FALSE}
library(FactoMineR)
library(Matrix)
library(ggplot2)
```

```{r, include=FALSE}
# Lectura de la base de dades
bd <- get(load('data_post_pca.RData'))
```

Per començar s'han d'escollir quines variables seran les variables actives, i quines les complementàries:

**Categòriques actives**:

- scolarship

- target

- gender

- daytime_attendance

- occupation_mother

- course

**Categòriques suplementàries**:

- Nationality

- Special_needs

- occupation_father

- previous_qualification

**Numèriques suplementàries**:

Com en l'ACP es va decidir no eliminar cap variable numèrica, s'utilitzaran totes les variables numèriques com a variables suplementàries.

A partir d’aquesta selecció es procedirà a realitzar l’ACM segons el mètode de Burt. Es comença quantificant la inèrcia de cada dimensió a partir de la variància explicada de cada una.

```{r, out.width="95%"}
res.mca <- MCA(bd, quanti.sup = c(10:17), quali.sup = c(3,4,6,7), method = "Burt")
res.mca
```

En els gràfics obtinguts es pot veure la variabilitat que expressen cada una de les variables categòriques en funció de les dimensions 1 i 2. Aquelles variables que estiguin més a prop de l'origen de coordenades aporten molt poca informació respecte a la variabilitat de les dades i, per tant, són poc importants. En canvi, aquelles variables més allunyades del centre aporten informació més rellevant, com l'horari de classes o el curs. 

Es representen gràficament la inèrcia que explica cada una de les dimensions generades:

```{r, out.width="90%"}
barp <- barplot(res.mca$eig[,2], names.arg=1:nrow(res.mca$eig), ylim = c(0,21), 
                cex.names = 0.7, las = 2, xlab = c("Dimensions"), 
                ylab = c("Percentatge de variància explicada"), 
                main = "Inèrcia explicada per cada dimensió")
```

Si una dimensió té una inèrcia baixa, significa que totes les modalitats estan molt properes al centre de gravetat, i en conseqüència, són molt similars. A mesura que augmenta la inèrcia, va augmentant la distància al centre de gravetat i, per tant, es redueix la similitud.

Per poder estudiar-ho més a fons, es realitza la següent taula on es pot observar per a cada dimensió, el seu valor propi, el percentatge de variància (o inèrcia) explicada, i el percentatge de variància (o inèrcia) acumulada:

```{r}
round(res.mca$eig, 2)
```

Tenim un total de 23 dimensions. Es veu que la dimensió 1 és la que destaca més per sobre la resta, explicant un 14.90% de la variabilitat de les dades, seguida de les dimensions 2, que també destaca per sobre de la resta, explicant un 9.34% de la variabilitat de les dades. A partir de la dimensió 3, es veu que el gràfic s'estabilitza bastant ja fins a l'última dimensió. 

Per tant, en total les dues primeres dimensions ja expliquen un 24.25% de la variabilitat de les dades, i es necessiten 15 dimensions per arribar a tenir una inèrcia acumulada per sobre del 80%.

## Plot individus

Es representa gràficament com es distribueixen els individus en funció de les dues primeres dimensions que expliquen un 24.25% de la variabilitat:

```{r, out.width="95%"}
plot(res.mca, invisible = c("var","quali.sup"), cex=0.7)
```

A simple vista, es pot veure que els individus es diferencien en 3 grups. Tot i això, la gran majoria d'individus es concentren molt propers a l'origen de manera que aporten poca informació sobre quines variables rellevants tenen respecte als altres individus. Es passa a estudiar cada variable per observar si hi ha algun tipus d'associació entre elles.

## Plot variables

```{r}
# Totes les variables actives
newbd = bd[, c("target", "daytime_attendance","course","scholarship","gender", "occupation_mother")]
res.mca1<-MCA(newbd, method="Burt", graph=FALSE)
cats = apply(newbd, 2, function(x) nlevels(as.factor(x)))

mca1_vars_df = data.frame(res.mca1$var$coord, Variable = rep(names(cats), cats))
mca1_obs_df = data.frame(res.mca1$ind$coord)

ggplot(data = mca1_obs_df, aes(x = Dim.1, y = Dim.2)) +
  geom_hline(yintercept = 0, colour = "gray70") +
  geom_vline(xintercept = 0, colour = "gray70") +
  geom_point(colour = "gray50", alpha = 0.7) +
  geom_density2d(colour = "gray80") +
  geom_text(data = mca1_vars_df, 
            aes(x = Dim.1, y = Dim.2, 
                label = rownames(mca1_vars_df), colour = Variable), cex = 3) +
  
  ggtitle("MCA plot of variables using R package FactoMineR") +
  scale_colour_discrete(name = "Variable")+ 
  xlim(-1,2.2) + 
  ylim(-1.5,2)
```

Igual que en el gràfic per individus, es veu que les dades es divideixen en 3 grups. Es poden classificar segons els eixos com:

- Grup 1: X = [-1, 0.5], Y = [-1, 1]

- Grup 2: X = [0, 1], Y = [-0.5, 1]

- Grup 3: X = [1, 2], Y = [0.5, 2]

Amb totes les variables actives juntes, és impossible diferenciar-les i poder extreure'n conclusions, per això s'aniran fent gràfics de les diferents variables:

```{r, out.width="90%"}
# variable Scholarship
v1 = c(16:18)
data = mca1_vars_df[v1,]

ggplot(data = data, aes(x = Dim.1, y = Dim.2)) +
  geom_hline(yintercept = 0, colour = "gray70") +
  geom_vline(xintercept = 0, colour = "gray70") +
  geom_point(colour = "gray50", alpha = 0.7) +
  geom_density2d(colour = "gray80") +
  geom_text(data = data, 
            aes(x = Dim.1, y = Dim.2, 
                label = rownames(data), colour = Variable), cex = 3) +
  ggtitle("MCA plot of variables using R package FactoMineR") +
  scale_colour_discrete(name = "Variable") + 
  xlim(-1,2) + 
  ylim(-1.5,2)
```

A simple vista, es pot observar que totes les modalitats de la variable *Scholarship* no estan molt repartides en el gràfic. Es pot veure que les modalitats 'Unknown' i 'No' no expliquen gaire variabilitat en situar-se molt a prop del centre de gravetat de les dimensions. De totes maneres, la categoria 'Yes' sí que sembla que podria tenir certa rellevància explicativa (II quadrant).

```{r, out.width="90%"}
# variable Gender
v2 = c(19:21)
data = mca1_vars_df[v2,]

ggplot(data = data, aes(x = Dim.1, y = Dim.2)) +
  geom_hline(yintercept = 0, colour = "gray70") +
  geom_vline(xintercept = 0, colour = "gray70") +
  geom_point(colour = "gray50", alpha = 0.7) +
  geom_density2d(colour = "gray80") +
  geom_text(data = data, 
            aes(x = Dim.1, y = Dim.2, 
                label = rownames(data), colour = Variable), cex = 3) +
  ggtitle("MCA plot of variables using R package FactoMineR") +
  scale_colour_discrete(name = "Variable") + 
  xlim(-1,2) + 
  ylim(-1.5,2)
```

Com en la variable Scholarship, en la variable *Gender* s'observa que totes les seves modalitats queden agrupades al voltant de l'origen de coordenades. En aquest cas les modalitats 'Female' i 'Unknown' no aporten informació que pugui ser útil, mentre que la categoria 'Male' queda una mica més lluny (quadrant IV) i sembla que podria tenir certa associació.

```{r, out.width="90%"}
# variable daytime_attendance
v3 = c(5:7)
data = mca1_vars_df[v3,]

ggplot(data = data, aes(x = Dim.1, y = Dim.2)) +
  geom_hline(yintercept = 0, colour = "gray70") +
  geom_vline(xintercept = 0, colour = "gray70") +
  geom_point(colour = "gray50", alpha = 0.7) +
  geom_density2d(colour = "gray80") +
  geom_text(data = data, 
            aes(x = Dim.1, y = Dim.2, 
                label = rownames(data), colour = Variable), cex = 3) +
  ggtitle("MCA plot of variables using R package FactoMineR") +
  scale_colour_discrete(name = "Variable") + 
  xlim(-1,2) + 
  ylim(-1.5,2)
```

Pel que fa a la variable *daytime_attendance* es veu que les modalitats es reparteixen d'una forma força interessant en el gràfic. Si bé les modalitats 'Daytime' i 'Unknown' expliquen poca variabilitat en quedar a prop del centre, la categoria 'Evening' queda més separada i se situa en el quadrant I de forma clara.

```{r, out.width="90%"}
# variable Target
v4 = c(1:4)
data = mca1_vars_df[v4,]

ggplot(data = data, aes(x = Dim.1, y = Dim.2)) +
  geom_hline(yintercept = 0, colour = "gray70") +
  geom_vline(xintercept = 0, colour = "gray70") +
  geom_point(colour = "gray50", alpha = 0.7) +
  geom_density2d(colour = "gray80") +
  geom_text(data = data, 
            aes(x = Dim.1, y = Dim.2, 
                label = rownames(data), colour = Variable), cex = 3) +
  ggtitle("MCA plot of variables using R package FactoMineR") +
  scale_colour_discrete(name = "Variable") + 
  xlim(-1,2) + 
  ylim(-1.5,2)
```

Altra vegada, es veu que totes les modalitats de la variable *Target* es concentren al voltant del centre i sense gaire variabilitat. Tot i això, hi ha dues modalitats que sembla que podrien aportar certa informació. La categoria 'Dropout' se situa de forma més clara al quadrant IV i la categoria 'Graduate' se situa al quadrant II.

```{r, out.width="90%"}
# variable occupation_mother
v5 = c(22:30)
data = mca1_vars_df[v5,]

ggplot(data = data, aes(x = Dim.1, y = Dim.2)) +
  geom_hline(yintercept = 0, colour = "gray70") +
  geom_vline(xintercept = 0, colour = "gray70") +
  geom_point(colour = "gray50", alpha = 0.7) +
  geom_density2d(colour = "gray80") +
  geom_text(data = data, 
            aes(x = Dim.1, y = Dim.2, 
                label = rownames(data), colour = Variable), cex = 3) +
  ggtitle("MCA plot of variables using R package FactoMineR") +
  scale_colour_discrete(name = "Variable") + 
  xlim(-1,2) + 
  ylim(-1.5,2)
```

Observant la variable *Occupation_mother* es veu que totes les modalitats d'aquesta variable s'agrupen al voltant del centre. Si bé hi ha algunes variables que es poden situar de forma més clara en un dels quadrants o lluny de l'origen, en quedar totes molt a prop entre elles no hi ha prou certesa per assegurar que aporten informació verídica. 

```{r, out.width="90%"}
# variable course
v6 = c(8:15)
data = mca1_vars_df[v6,]

ggplot(data = data, aes(x = Dim.1, y = Dim.2)) +
  geom_hline(yintercept = 0, colour = "gray70") +
  geom_vline(xintercept = 0, colour = "gray70") +
  geom_point(colour = "gray50", alpha = 0.7) +
  geom_density2d(colour = "gray80") +
  geom_text(data = data, 
            aes(x = Dim.1, y = Dim.2, 
                label = rownames(data), colour = Variable), cex = 3) +
  ggtitle("MCA plot of variables using R package FactoMineR") +
  scale_colour_discrete(name = "Variable") + 
  xlim(-1,2) + 
  ylim(-1.5,2)
```

Pel que fa a la variable *Course*, es veu que gran part de les seves modalitats s'agrupen al centre menys una. La categoria 'Management(PM)' se situa lluny de totes les altres i en el quadrant I. D'altra banda, les modalitats 'Social Service' i 'Nursing' si situen també lleugerament lluny del centre i en el quadrant II.

## Associacions

Havent estudiat cada una de les variables per separat s'ha pogut veure que hi ha certes modalitats de diferents variables que se situen en una mateixa zona del gràfic. Això significa que pot haver-hi certa associació entre aquestes modalitats, tot i que no es pot entrar a definir quin tipus de relació es dona entre elles. També s'ha de tenir en compte que havent utilitzat aquestes dues dimensions només es pot explicar un percentatge reduït de la variabilitat (24.25%). Així doncs, si es tinguessin les eines per poder utilitzar més dimensions, es podrien obtenir uns resultats més verídics i lleugerament diferents.

Les associacions que s'han trobat són les següents:

- En el quadrant I hi coincideixen aquells individus que van de tardes i els que estudien el curs de Management.

- En el quadrant II es troben aquells estudiants que estudien Social Service o Nursing, que han aconseguit graduar-se i han tingut una beca. 

- En el quadrant IV es troben generalment els estudiants homes i els que han abandonat la carrera. 

\pagebreak

# Clustering jeràrquic sobre les components factorials retingudes a l’ACP

Es fa el clustering per l'ACP. Tenim les coordenades de cada individu en les 5 dimensions que comprenen un 80% de la inèrcia. Amb aquestes dades es calcula la distància euclidiana, ja que són dades numèriques, s'aplica el mètode de Ward per fer el clustering, i posteriorment graficar el dendrograma. 

```{r, include=FALSE}
# install.packages("factoextra")
# install.packages("NbClust")
library(factoextra)
library(FactoMineR)
library('dendextend')
library(scales)
library(cluster)

load("data_post_pca.RData")
numeriques <- which(sapply(data,is.numeric))
numeriques

numer <- data[,numeriques]
sapply(numer,class)
pc1 <- prcomp(numer, scale = TRUE)
psi <- pc1$x[,1:5]
hc2 <- hclust(daisy(psi, metric = "euclidean"), "ward.D2")
dendo2 <- as.dendrogram(hc2)
```

Es veu clarament que el nombre òptim de grups per classificar les dades és 7:

```{r, out.width="80%"}
plot(dendo2)
```

Es visualitzen els 7 clústers:

```{r, out.width="80%"}
classes <- cutree(hc2, 7)
# save(classes, file="7classes.RData")
colors <- c("salmon","orange3","chartreuse4","lightseagreen","deepskyblue","lightslateblue","maroon3")
colors_dendo <- color_branches(dendo2, labels = classes, k = 7, col = colors)
plot(colors_dendo)
```

## Profiling post ACP i ACM

```{r}
# Cargamos los datos
```

```{r}
# load("data_post_pca.RData")
# load("7classes.RData")
```

```{r}
# Número de personas en cada grupo
```

```{r}
# summary(factor(classes))
```

```{r}
# Definimos las funciones que calculan la significación de las variables mediante el p-valor
```

```{r}
# ValorTestXnum <- function(Xnum,P){
#   #freq dis of fac
#   nk <- as.vector(table(P)); 
#   n <- sum(nk); 
#   #mitjanes x grups
#   xk <- tapply(Xnum,P,mean);
#   #valors test
#   txk <- (xk-mean(Xnum))/(sd(Xnum)*sqrt((n-nk)/(n*nk))); 
#   #p-values
#   pxk <- pt(txk,n-1,lower.tail=F);
#   for(c in 1:length(levels(as.factor(P)))){if (pxk[c]>0.5){pxk[c]<-1-pxk[c]}}
#   return (pxk)
# }
# 
# 
# ValorTestXquali <- function(P,Xquali){
#   taula <- table(P,Xquali);
#   n <- sum(taula); 
#   pk <- apply(taula,1,sum)/n;
#   pj <- apply(taula,2,sum)/n;
#   pf <- taula/(n*pk);
#   pjm <- matrix(data=pj,nrow=dim(pf)[1],ncol=dim(pf)[2], byrow=TRUE);      
#   dpf <- pf - pjm; 
#   dvt <- sqrt(((1-pk)/(n*pk))%*%t(pj*(1-pj))); 
#   zkj <- dpf
#   zkj[dpf!=0]<-dpf[dpf!=0]/dvt[dpf!=0]; 
#   pzkj <- pnorm(zkj,lower.tail=F);
#   for(c in 1:length(levels(as.factor(P)))){for (s in 1:length(levels(Xquali))){if (pzkj[c,s]> 0.5){pzkj[c,s]<-1- pzkj[c,s]}}}
#   return (list(rowpf=pf,vtest=zkj,pval=pzkj))
# }
```

```{r}
# Preparamos los objetos necesarios para las herramientas gráficas
```

```{r}
# #datos sin columna de clústers
# dades <- data
# 
# #número de variables
# K <- ncol(dades)
# 
# #grupos de los clústers
# P <- classes
# nameP <- "classe"
# 
# #número de clústers
# nc <- length(levels(factor(P)))
# 
# #matriz y vector donde añadiremos los p-valores de cada variable
# pvalk <- matrix(data=0,nrow=nc,ncol=K, dimnames=list(levels(as.factor(P)),names(dades)))
# chis <- c()
# 
# #número de observaciones
# n <- dim(dades)[1]
```

```{r}
# Calculamos los p-valores de las variables categóricas y numéricas
```

```{r}
# # Generamos dos tablas, una para las categóricas y otra para las numéricas
# for(k in 1:K){
#   if (is.numeric(dades[,k])){ 
#     for(s in levels(as.factor(P))) 
#     pvalk[,k]<-ValorTestXnum(dades[,k], P)
#   }else{
#     tab <- table(dades[,k],as.factor(P))
#     chis[k]<-(chisq.test(tab)$p.value)
#   }
# }
# 
# #Añadimos los nombres de variable a las tablas
# names(chis) <- colnames(pvalk)
# # Juntamos las tablas
# pvalorsvars <- colMeans(pvalk)
# pvalorsvars[c(1:9,18)]<- chis[c(1:9,18)]
# 
# #Creamos una tabla que nos indica si es sigificativa o no
# significativa <- pvalorsvars
# for(i in 1:length(pvalorsvars)){
#   if(pvalorsvars[i]<0.05){significativa[i]<-1}else{significativa[i] <- 0}
# }
```

```{r}
# Tabla de los p-valores de las numéricas
```

```{r}
# pvalk[,10:17]
```

```{r}
# Tabla de los p-valores de las categóricas
```

```{r}
# chis[c(1:9,18)]
```

```{r}
# Tabla que nos dice si son significativas o no
# SIGNIFICATIVA
```

```{r}
# Generación de todos los gráficos de las variables que son significativas
```

```{r}
# for(k in 1:K){
#   if (is.numeric(dades[,k]) && significativa[k]==1){ 
#     print(paste("Anàlisi per classes de la Variable:", names(dades)[k]))
#     barplot(tapply(dades[[k]], P, mean),main=paste("Means of", names(dades)[k], "by", nameP ))
#     abline(h=mean(dades[[k]]))
#     legend(0,mean(dades[[k]]),"global mean",bty="n")
#     print("Estadístics per groups:")
#     for(s in levels(as.factor(P))) {print(summary(dades[P==s,k]))}
#     o<-oneway.test(dades[,k]~P)
#     print(paste("p-valueANOVA:", o$p.value))
#     kw<-kruskal.test(dades[,k]~P)
#     print(paste("p-value Kruskal-Wallis:", kw$p.value))
#     print("p-values ValorsTest: ")
#     print(pvalk[,k])      
#   }else if(!is.numeric(dades[,k]) && significativa[k]==1){
#       #qualitatives
#     
#       print(paste("Variable", names(dades)[k]))
#       table<-table(P,dades[,k])
#       #   print("Cross-table")
#       #   print(table)
#       rowperc<-prop.table(table,1)
#       
#       colperc<-prop.table(table,2)
#       #  print("Distribucions condicionades a files")
#       # print(rowperc)
#       
#       #ojo porque si la variable es true o false la identifica amb el tipus Logical i
#       #aquest no te levels, por tanto, coertion preventiva
#       
#       dades[,k]<-as.factor(dades[,k])
#       
#       
#       marg <- table(as.factor(P))/n
#       print(append("Categories=",levels(as.factor(dades[,k]))))
#       
#       #from next plots, select one of them according to your practical case
#       
#       par(mar=c(5,4,4,8), xpd=TRUE)
#       plot(marg,type="l",ylim=c(0,1),main=paste("Prop. of pos & neg by",names(dades)[k]))
#       paleta<-rainbow(length(levels(dades[,k])))
#       for(c in 1:length(levels(dades[,k]))){lines(colperc[,c],col=paleta[c]) }
#       legend("topright", levels(dades[,k]), col=paleta, lty=2, cex=0.6)
#       
#       #condicionades a classes
#       print(append("Categories=",levels(dades[,k])))
#       par(mar=c(5,4,4,8), xpd=TRUE)
#       plot(marg,type="n",ylim=c(0,1),main=paste("Prop. of pos & neg by",names(dades)[k]))
#       paleta<-rainbow(length(levels(dades[,k])))
#       for(c in 1:length(levels(dades[,k]))){lines(rowperc[,c],col=paleta[c]) }
#       legend("topright", levels(dades[,k]), col=paleta, lty=2, cex=0.6)
#       
#       #amb variable en eix d'abcisses
#       marg <-table(dades[,k])/n
#       print(append("Categories=",levels(dades[,k])))
#       par(mar=c(5,4,4,8), xpd=TRUE)
#       plot(marg,type="l",ylim=c(0,1),main=paste("Prop. of pos & neg by",names(dades)[k]), las=3)
#       #x<-plot(marg,type="l",ylim=c(0,1),main=paste("Prop. of pos & neg by",names(dades)[k]), xaxt="n")
#       #text(x=x+.25, y=-1, adj=1, levels(CountryName), xpd=TRUE, srt=25, cex=0.7)
#       paleta<-rainbow(length(levels(as.factor(P))))
#       for(c in 1:length(levels(as.factor(P)))){lines(rowperc[c,],col=paleta[c]) }
#       legend("topright", levels(as.factor(P)), col=paleta, lty=2, cex=0.6)
#       
#       #condicionades a columna 
#       par(mar=c(5,4,4,8), xpd=TRUE)
#       plot(marg,type="n",ylim=c(0,1),main=paste("Prop. of pos & neg by",names(dades)[k]), las=3)
#       paleta<-rainbow(length(levels(as.factor(P))))
#       for(c in 1:length(levels(as.factor(P)))){lines(colperc[c,],col=paleta[c]) }
#       legend("topright", levels(as.factor(P)), col=paleta, lty=2, cex=0.6)
#       
#       table<-table(dades[,k],P)
#       print("Cross Table:")
#       print(table)
#       print("Distribucions condicionades a columnes:")
#       print(colperc)
#       
#       #diagrames de barres adosades
#       par(mar=c(5,4,4,8), xpd=TRUE)
#       paleta<-rainbow(length(levels(dades[,k])))
#       barplot(table(dades[,k], as.factor(P)), beside=TRUE,col=paleta)
#       legend("topright",levels(as.factor(dades[,k])),pch=1,cex=0.5, col=paleta)
#       
#       print("Test Chi quadrat: ")
#       print(chisq.test(dades[,k], as.factor(P)))
#       
#       print("valorsTest:")
#       print( ValorTestXquali(P,dades[,k]))
# 
#       # g[k] <- ValorTestXquali(P,dades[,k])
#       #calcular els pvalues de les quali
#     }
#   }#endfor
```

Com ja s'ha mencionat a l'apartat de profiling, s'elaboren els perfils per poder diferenciar entre grups amb la distinció adequada. S'utilitzarà el mateix procés d'anàlisi i les mateixes eines gràfiques.
 
Primerament, s'estudia el p-valor de les variables numèriques, observant quines són significatives, amb el nivell de significació establit en $\alpha = P(error \ \ tipus \ I) = 0.05$.
 
![]("Image1.png")
 
Per mitjà del test chi-quadrat, de cadascuna respecte als clústers, es mira quines variables categòriques són significatives per definir els clústers.
 
![]("Image2.png")
 
A la següent taula es mostra el valor 1 de les variables considerades com a significatives. Aquestes seran les estudiades gràficament.

![]("Image3.png")

Es descarten les variables:

- Nacionalitat de l’estudiant

- Necessitats especials

- Unitats curriculars suspeses

- Taxa d'atur

- PIB


### Anàlisi gràfica de les variables numèriques

*EDAT*

![]("Image4.png")

A aquest gràfic es veu com el clúster més allunyat de la mitjana és el tres, els grups dos i sis són els més joves, amb 20 anys de mitjana. La resta es troben al voltant de la mitjana. Es considera que són prou significatives les diferències per a explicar els grups.

\pagebreak

*NOTES AL PRIMER SEMESTRE*

![]("Image5.png")

Per a la variable que tracta sobre les notes al primer semestre, els clústers més significatius són l'1 i el 7 amb les notes mitjanes més baixes, suspeses. Les millors notes són dels grups 2, 3, 5 i 6, molt properes com per poder diferenciar. El grup 4 es troba per sota la mitjana, però propera a aquesta.

*NOTES AL SEGON SEMESTRE*
 
![]("Image6.png")

S'observa com les notes al segon semestre segueixen la mateixa tendència que les notes al primer semestre. Parlant dels grups amb les notes més baixes, el grup 1 baixa la seva mitjana i el grup 7 la puja una mica, però no suficient per a apropar-se a la resta de clústers.

\pagebreak

*UNITATS CURRICULARS SUSPESES*

![]("Image7.png")

Parlant del nombre d'unitats curriculars suspeses al segon semestre, el clúster 7 és el que més unitats curriculars suspeses té, seguit pel grup 4. La resta de grups no tenen quasi unitats curriculars suspeses.
 
*TAXA D’INFLACIÓ*

![]("Image8.png")

El grup 5 és el que contempla una taxa d'inflació al seu país de procedència més alta. Per altra banda, el 2 és el que menys taxa presenta. La resta de grups són propers a la mitjana global.

Com a conclusió general, sobre els clústers a les variables numèriques, el clúster 1 és el més significatiu, sent el millor a 2 de 6 variables estudiades. A la resta de variables han destacat per igual els grups 2, 3, 5 i 7. Els grups 4 i 6 no han destacat a cap de les variables estudiades.

\pagebreak

### Anàlisi gràfica de les variables categòriques

*GRAU DE L'ESTUDIANT*

![]("Image9.png")

![]("Image10.png")

![]("Image11.png")

Als tres gràfics, si un es fixa en les distribucions marginals, en les quantitats a cada clúster i les proporcions per cadascun, es pot observar com:

El clúster 3 és, majoritàriament, dels estudiants de Management (PM).

El clúster 7 és dels estudiants d'infermeria.

Al clúster 4, majoritàriament, hi ha els estudiants de veterinària.

A la resta de clústers no s'observa que cap grau destaqui.

\pagebreak

*HORARI DE L'ESTUDIANT*

![]("Image12.png")

![]("Image13.png")

S'observa com quasi tots els clústers segueixen la mateixa distribució. El grup 3 és l'excepció, el qual diu que és significatiu. Es pot dir que és un grup que van tan de matí com de tarda, però, sobretot de tarda. Cal també mencionar que al clúster 6 hi ha menys proporció d'horari de tarda.

\pagebreak

*QUALIFICACIÓ PRÈVIA DE L'ESTUDIANT*

![]("Image14.png")

![]("Image15.png")

![]("Image16.png")

Es veu com la majoria de les titulacions es distribueixen voltant la mitjana global, el que no aporta molta informació, per tal de diferenciar els clústers. Però hi ha algunes diferències, les quals, poden explicar les diferències entre grups. El grup 6 no té quasi estudiants de 11th year, degree o other. El grup 7 és d'estudiants amb titulació prèvia de tech specialzation.

*OCUPACIÓ DE LA MARE*

![]("Image17.png")

Al gràfic es veu com el clúster 3, majoritàriament, és de les mares Admin. La resta de categories, gairebé, no expliquen els clústers.

\pagebreak

*OCUPACIÓ DEL PARE*

![]("Image18.png")

S'observa com a tots els grups segueix la mateixa distribució. Excepte al clúster 5, majoritàriament, els pares tenen una ocupació unskilled, i al clúster 4 que tenen altre tipus de treball.

*GÈNERE*

![]("Image19.png")

A les distribucions dels clústers, observant el gràfic de barres adossades, es conclou que la majoria dels clústers es distribueixen de la mateixa manera, amb la meitat d'homes, que de dones. El clúster 1 trenca aquesta tendència i mostra que el nombre d'homes com de dones és quasi igual, així inclòs, els homes superant a les dones. El grup 4 segueix la mateixa tendència que l'1, i al 6 es veu major quantitat, proporcionalment, de dones que d'homes, a comparació de com es distribueixen els valors en la resta de clústers.

*BECA*

![]("Image20.png")

![]("Image21.png")

Més o menys, a tots els grups la proporció de becats i no becats és la mateixa. Excepte al grup 6 on s'observa que hi ha més proporció de becats. El grup 7 no té alumnes becats.

\pagebreak

*RESULTAT ACADÈMIC*

![]("Image22.png")

![]("Image23.png")

Als dos gràfics s'observa com el primer grup està construït pels estudiants que abandonen els estudis, els grups 4 i 7 també mostren un major nombre d'abandonaments, a comparació de la resta de grups. Sobretot al grup 6, i també a la resta, la majoria d'estudiants es graduen.

\pagebreak

### Conclusió sobre els clústers a les variables numèriques i categòriques

**Clúster 1**: Destaca en les notes més baixes als dos semestres, major proporció d'homes. És el grup dels estudiants que deixen d'estudiar i no tenen beca.
 
**Clúster 2**: Destaca en ser un dels grups més joves, amb la taxa d'inflació al país de procedència més baixa.
 
**Clúster 3**: Destaca en ser el grup de més edat entre tots, amb mares que treballen d'admin. És el grup dels estudiants de Management, que majoritàriament fan horari de tarda i es graduen tant com ho deixen.
 
**Clúster 4**: Destaca en ser el clúster d'estudiants de veterinària, format tant per homes com per dones. És el segon grup que més unitats curriculars suspeses, amb una nota mitjana per sota la mitjana dels grups i majoritàriament deixen d'estudiar.
 
**Clúster 5**: Destaca en tenir la taxa d'inflació més alta pel país de procedència, amb pares en una ocupació unskilled.
 
**Clúster 6**: Destaca en ser l'altre grup amb estudiants més joves, majoritàriament dones, amb major proporció d'alumnes becats. És el grup dels estudiants que es graduen, amb una titulació prèvia bàsica, de secundària o alguna especialització tècnica.
 
**Clúster 7**: Destaca en ser un grup amb notes molt baixes, suspeses als dos semestres. És el grup dels estudiants d'infermeria, amb major nombre d'unitats curriculars suspeses, que deixen la carrera i amb una titulació prèvia d'especialització tècnica.
 
### Comparació dels profilings

S'observa com al primer profiling les variables no prou significatives per a ser estudiades són:

- Nacionalitat de l’estudiant

- Necessitats especials

- Unitats curriculars suspeses al segon semestre

- Taxa de desocupació

Mentre al segon profiling es descarten:

- Nacionalitat de l’estudiant

- Necessitats especials

- Unitats curriculars suspeses al primer semestre

- Taxa de desocupació

- PIB

Al segon profiling s'intercanvien les unitats curriculars suspeses entre semestres i s'afegeix una nova variable a la llista de descarts, el PIB.

Se sap que els dos processos de clustering interpretats presenten algunes diferències notables. En el primer procés, s'han identificat tres grups d'estudiants, mentre que en el segon procés s'han identificat set grups.

En el primer procés, el clúster 1 s'ha identificat com el grup d'estudiants que deixen els seus estudis i estudiants sense beca, i en el segon procés el clúster 1 s'ha identificat gairebé de la mateixa manera. En el segon procés, el perfil d'aquest grup és més detallat. S'observa un altre grup, del segon profiling, que també mostra similituds, aquest és el grup 7, que mostra notes baixes, major nombre d'unitats curriculars suspeses i a més, són estudiants d'infermeria que deixen la carrera. Un altre grup que es podria apropar a aquest primer grup és el 4, que encara que no té notes tan baixes, és el següent grup amb major nombre d'unitats curriculars suspeses, a més de categoritzar-los com a estudiants de veterinària, i que en parts iguals es graduen i deixen la carrera.

En el primer procés, el clúster 2 s'ha identificat com el grup d'estudiants graduats, amb beca, majoritàriament dones i estudiants de matí. En el segon procés, el clúster 2 s'ha identificat com un dels grups més joves, amb la taxa d'inflació més baixa del país d'origen. Aquestes són dues característiques molt diferents, per la qual cosa sembla que aquests dos clústers són completament diferents. Però, s'observa que el grup 6, creat en el segon procés, mostra bastants similituds, major quantitat de becats, graduats, majoritàriament dones, etc.

En el primer procés, el clúster 3 s'ha identificat com el grup d'estudiants amb edats més avançades, amb un menor nombre d'unitats curriculars suspeses i un horari de tarda. En el segon procés, el clúster 3 s'ha identificat com el grup d'estudiants més gran, amb mares que treballen com a administratives. A més, són estudiants de Management, que majoritàriament fan horari de tarda i es graduen tant com deixen els seus estudis. Tot i que hi ha algunes similituds, com l'edat avançada i l'horari de tarda, sembla que aquest clúster detalla més característiques del mateix grup.

D'altra banda, tenim el grup 5, del segon procés. Aquest no té prou característiques similars per a observar qualsevol similitud, però per les notes i altres característiques, podria venir del grup 2 del primer profiling.

En general, sembla que el segon procés de clustering és més detallat i precís en la seva descripció dels estudiants i els seus comportaments acadèmics. A més, presenta un major nombre de clústers, cosa que permet una classificació més detallada dels diferents perfils d'estudiants.

## Clústers representats sobre els dos primers plans factorials

```{r}
library(ggplot2)
data = get(load('prepro_data.Rdata'))
load("7classes.Rdata")
numeric <- which(sapply(data, is.numeric))
data_numeric <- data[, numeric]
pc1 <- prcomp(data_numeric, scale = TRUE)
```

Es representen les dades dividides per grups en els dos primers plans factorials de l'ACP:

```{r, out.width="95%"}
numer <- data_numeric
numer$clusters <- as.factor(classes)

PC1 <- pc1$x[,1]
PC2 <- pc1$x[,2]
ggplot(numer, 
       aes(x = PC1, 
           y = PC2, 
           color = clusters)) +
  geom_point() +
  stat_ellipse() +
  geom_hline(yintercept = 0, colour = "gray70") +
  geom_vline(xintercept = 0, colour = "gray70") 
```

Al gràfic es pot veure que per les dues primeres dimensions, que estan explicades especialment per les notes, els estudiants de veterinària (la segona component només) i els estudiants d'infermeria, els grups que s'allunyen del centre són els 4 i 7.

El grup 7 està conformat per les persones que estudien infermeria, tenen notes baixes, unitats curriculars suspeses i han deixat la carrera. El grup 4 està conformat per estudiants de veterinària que tenen unitats curriculars suspeses. L'únic altre grup que es distingeix una mica és l'1, que són per persones que deixen els estudis. La resta de grups estan barrejats al centre. 

```{r}
# ggplot(numer, 
#        aes(x = PC1, 
#            y = PC2, 
#            color = clusters)) +
#   geom_point() +
#   stat_ellipse() +
#   geom_hline(yintercept = 0, colour = "gray70") +
#   geom_vline(xintercept = 0, colour = "gray70") + 
#   xlim(-3,2) + 
#   ylim(-5,2)
```

\pagebreak

# Anàlisi discriminant lineal

L'anàlisi discriminant lineal, o LDA, és un mètode de classificació dins de l'aprenentatge supervisat que permet classificar una variable categòrica entre els seus diferents nivells. Per classificar entre diferents classes s'estimen una o diverses funcions discriminants, que representen hiperplans i separen l'espai d'observacions en diferents regions.

Com que el LDA està basat en mètodes factorials, es prenen només les columnes numèriques com a variables predictives. 

La variable que es vol classificar és la variable Target, la qual té 4 modalitats: Dropout, Enrolled, Graduate i Unknown. S'eliminen les observacions de la modalitat Unknown, ja que en realitat són *missing values* i no té sentit que formin una categoria específica en la qual classificar observacions.

```{r}
data = get(load('data_post_pca.RData'))

# es pren la columna Target com a variable objectiu que es vol predir
data$target <- as.factor(data$target)

# s'eliminen les files que són unknown (no té gaire sentit mantenir-les des d'un punt de vista de classificació)
data_clas = subset(data, target != 'Unknown')
data_clas$target <- droplevels(data_clas$target)

# es recodifica la variable objectiu
levels(data_clas$target) = c(1:3)

# es necessiten X's numèriques
numeric = which(sapply(data_clas, is.numeric))
data_numeric = data_clas[, numeric]
# data_numeric = scale(data_numeric) --> estandarditzar totes les columnes no millora els resultats de la classificació
```

Com que hi ha 3 modalitats per a la variable Target, es busquen dues funcions discriminants per garantir que es pugui arribar a discriminar i separar entre les tres classes. La següent taula mostra els coeficients de les funcions discriminants:

```{r}
library(knitr)
library(MASS)

lda = lda(data_numeric, grouping = data_clas$target)

kable(lda$scaling[,1:2], format = "simple")
```

Com que s'han calculat dues funcions discriminants, apareixen dues columnes noves que s'afegeixen a la base de dades que conté les columnes numèriques de la base original. 

```{r}
# es col·loquen els valors dels coeficients en dues columnes noves
lda.values = predict(lda, data_numeric)
data_clas$lda1 = lda.values$x[,1]
data_clas$lda2 = lda.values$x[,2]
names(data_clas$lda1) = 'LDA1'
names(data_clas$lda2) = 'LDA2'
```

```{r funció descriptiva de cada grup, include=FALSE}
calcWithinGroupsVariance <- function(variable,groupvariable)
{
  # find out how many values the group variable can take
  groupvariable2 <- as.factor(groupvariable[[1]])
  levels <- levels(groupvariable2)
  numlevels <- length(levels)
  # get the mean and standard deviation for each group:
  numtotal <- 0
  denomtotal <- 0
  for (i in 1:numlevels)
  {
    leveli <- levels[i]
    levelidata <- variable[groupvariable==leveli,]
    levelilength <- length(levelidata)
    # get the standard deviation for group i:
    sdi <- sd(levelidata)
    numi <- (levelilength - 1)*(sdi * sdi)
    denomi <- levelilength
    numtotal <- numtotal + numi
    denomtotal <- denomtotal + denomi
  }
  # calculate the within-groups variance
  Vw <- numtotal / (denomtotal - numlevels)
  return(Vw)
}
```

```{r funció estandaritzadora dels grups, include=FALSE}
groupStandardise <- function(variables, groupvariable)
{
  # find out how many variables we have
  variables <- as.data.frame(variables)
  numvariables <- length(variables)
  # find the variable names
  variablenames <- colnames(variables)
  # calculate the group-standardised version of each variable
  for (i in 1:numvariables)
  {
    variablei <- variables[i]
    variablei_name <- variablenames[i]
    variablei_Vw <- calcWithinGroupsVariance(variablei, groupvariable)
    variablei_mean <- mean(as.matrix(variablei))  
    variablei_new <- (variablei - variablei_mean)/(sqrt(variablei_Vw))
    data_length <- nrow(variablei)
    if (i == 1) { variables_new <- data.frame(row.names=seq(1,data_length)) }
    variables_new[`variablei_name`] <- variablei_new
  }
  return(variables_new)
}
```

```{r funció variància entre grups, include=FALSE}
calcBetweenGroupsVariance <- function(variable,groupvariable)
{
  # find out how many values the group variable can take
  groupvariable2 <- as.factor(groupvariable[[1]])
  levels <- levels(groupvariable2)
  numlevels <- length(levels)
  # calculate the overall grand mean:
  grandmean <- mean(as.matrix(variable) )         
  # get the mean and standard deviation for each group:
  numtotal <- 0
  denomtotal <- 0
  for (i in 1:numlevels)
  {
    leveli <- levels[i]
    levelidata <- variable[groupvariable==leveli,]
    levelilength <- length(levelidata)
    # get the mean and standard deviation for group i:
    meani <- mean( as.matrix(levelidata) )
    sdi <- sd(levelidata)
    numi <- levelilength * ((meani - grandmean)^2)
    denomi <- levelilength
    numtotal <- numtotal + numi
    denomtotal <- denomtotal + denomi
  }
  # calculate the between-groups variance
  Vb <- numtotal / (numlevels - 1)
  Vb <- Vb[[1]]
  return(Vb)
}
```

```{r funció que calcula la separació entre grups, include=FALSE}
calcSeparations <- function(variables,groupvariable)
{
  # find out how many variables we have
  variables <- as.data.frame(variables)
  numvariables <- length(variables)
  # find the variable names
  variablenames <- colnames(variables)
  # calculate the separation for each variable
  for (i in 1:numvariables)
  {
    variablei <- variables[i]
    variablename <- variablenames[i]
    Vw <- calcWithinGroupsVariance(variablei, groupvariable)
    Vb <- calcBetweenGroupsVariance(variablei, groupvariable)
    sep <- Vb/Vw
    print(paste("variable", variablename, "Vw =", Vw, "Vb =", Vb, 
                "separation =", sep))
  }
}
```

```{r}
calcSeparations(lda.values$x, data_clas$target)
```

\pagebreak

Es dibuixen en un histograma els coeficients de cada funció discriminant. 

```{r, out.width="95%"}
library(tidyverse)
#total separation (la suma de les dues)
#percentatge que separa cada una, coincideix amb la proportion of trace del model discriminant
gg <- data.frame(lda.values$x)
ggplot(gg, aes(x=LD1)) + 
  geom_histogram(color="lightblue", fill="lightblue", binwidth=0.5) + 
  theme_minimal()

ggplot(gg, aes(x=LD2)) + 
  geom_histogram(color="lightblue", fill="lightblue", binwidth=0.5) +
  theme_minimal()
```

Es poden també representar en histogrames els coeficients de la funció discriminant segons el nivell de la variable Target.

LD1

```{r, out.width="88%"}
# histograma múltiple entre la funció discriminant i la resposta (3 histogrames perquè  hi ha 3 modalitats: Graduate, Dropout i Enrolled)
par(mar=c(1,1,1,1))
par(mar=c(5.1,4.1,4.1,2.1))
par(mar=c(3,2.5,1.5,1))
ldahist(data = lda.values$x[,1], g = data_clas$target, ymax = 1)
```

LD2

```{r, out.width="88%"}
ldahist(data = lda.values$x[,2], g = data_clas$target)
```

Es poden també representar les diferents classes de la següent manera: 

```{r}
plot(data_clas$lda1, data_clas$lda2)
text(lda.values$x[, 1], lda.values$x[, 2], data_clas$target, cex = 0.7, pos = 4, 
     col = levels(data_clas$target)) 
```

```{r}
lda$scaling[, 2]
lda$scaling[, 1]
```

```{r}
# predicció de les classes
data_clas$pred = 0
for(i in 1:dim(data_clas)[1]){
  if(data_clas$lda1[i] < 0){data_clas$pred[i] = 2
  }else{if (data_clas$lda2[i]){data_clas$pred[i] = 1 
  }else{
    data_clas$pred[i] = 3
  }
  }
}
```

En tots els gràfics s'aprecia el mateix, no es discriminen bé les modalitats.

Un cop s'han predit les classes de la variable Target, es pot calcular la matriu de confusió per avaluar la precisió de les funcions discriminants que s'han calculat a l'hora de separar les classes. 

```{r}
# matriu de confusió
table(data_clas$target)
MC = table(data_clas$target, data_clas$pred)
```

S'observa, però, que la precisió del model és força baixa, al voltant del 15%.

```{r}
# precisió
(accuracy = sum(diag(MC))/dim(data_clas)[1])
```

Amb la precisió calculada, es pot obtenir l'error de classificació:

```{r}
# error de classificació
(error <- 1 - accuracy)
```

\pagebreak

# Anàlisi textual

```{r}
library(readxl)
finalDataset0_2 <- read_excel("finalDataset0.2.xlsx")
```

```{r}
df<- data.frame(finalDataset0_2$coursecontent...4)
```

```{r}
# install.packages("tidytext")
# install.packages("textdata")
# install.packages("tm")
# install.packages("SnowballC")
# install.packages("rJava")
# install.packages("wordcloud")
# install.packages("janeaustenr")
# install.packages("lda")
# install.packages("ldatuning")
# install.packages("topicmodels")
library(janeaustenr)
library(dplyr)
library(stringr)
library(textdata)
library(tidytext)
library(wordcloud)
library(SnowballC)
# library(rJava)
library(tm)
library(dplyr)
library(tm)
library(lda)
library(ldatuning)
library(topicmodels)
```

## Preprocessament

Per poder desenvolupar l'anàlisi textual primer cal preprocessar la base de dades amb l'objectiu de mantenir només aquella informació rellevant que permeti una anàlisi més precisa.

Aquest preprocessament inclou eliminar els espais en blanc, les majúscules, els signes de puntuació, els números, altres caràcters especials, les stop words (to, the, a...), etc. A més, s'aplica el procés de lematització de les paraules (transformar les paraules a la seva arrel per poder trobar més relacions entre textos diferents).

```{r}
# create corpus
review_corpus<- VCorpus(VectorSource(df))
## Step 1: Eliminating extra whitespace
review_corpus<- tm_map(review_corpus, stripWhitespace)
## Step 2: Transform to lowercase
review_corpus<- tm_map(review_corpus, content_transformer(tolower))
## remove punctuation
review_corpus<- tm_map(review_corpus, removePunctuation)
## remove numbers
review_corpus<- tm_map(review_corpus, removeNumbers)
## create custom function to remove other misc characters
text_preprocessing<- function(x)
{gsub('http\\S+\\s*','',x) # remove URLs
  gsub('#\\S+','',x) # remove hashtags
  gsub('[[:cntrl:]]','',x) # remove controls and special characters
  gsub("^[[:space:]]*","",x) # remove leading whitespaces
  gsub("[[:space:]]*$","",x) # remove trailing whitespaces
  gsub(' +', ' ', x) # remove extra whitespaces
}
review_corpus<-tm_map(review_corpus,text_preprocessing)
# remove stopwords
review_corpus<- tm_map(review_corpus, removeWords, stopwords("english"))
# you can also create custom stopwords based on your context
mystopwords<- c(stopwords("english"),"course","courses")
review_corpus<- tm_map(review_corpus, removeWords, mystopwords)
review_corpus<- tm_map(review_corpus, stripWhitespace)

library(textstem)
review_corpus<- tm_map(review_corpus, PlainTextDocument)
review_corpus<- tm_map(review_corpus, content_transformer(lemmatize_words))
```

S'agafen les paraules que surten 5 vegades o més per tenir aquella informació rellevant i les representem gràficament:

```{r}
# create term document matrix
tdm<- TermDocumentMatrix(review_corpus, control = list(wordlengths = c(1,Inf),  weighting = weightTf))
freq_terms<- findFreqTerms(tdm, lowfreq=5) #només agafem les paraules que apareixen 5 o mes vegades
term_freq<- rowSums(as.matrix(tdm))
term_freq<- subset(term_freq, term_freq>=5)
data<- data.frame(term = names(term_freq), freq = term_freq)

# plot word frequency
library(ggplot2)
data_plot<- data %>%
  top_n(25)
# Plot word frequency
ggplot(data_plot, aes(x = reorder(term, +freq), y = freq, fill = freq)) + geom_bar(stat = "identity")+ scale_colour_gradientn(colors = terrain.colors(10))+ xlab("Terms")+ ylab("Count")+coord_flip()
# create word cloud
# install.packages("wordcloud2")
library(wordcloud2)

# wordcloud2(data, color = "random-dark", backgroundColor = "white", shape="circle")
```

![]("word_cloud.png")

## Topic modeling

```{r, echo=FALSE, include=FALSE}
# #manera 1
# result <- ldatuning::FindTopicsNumber(
#   tdm,
#   topics = seq(from = 2, to = 20, by = 1),
#   metrics = c("CaoJuan2009",  "Deveaud2014"),
#   method = "Gibbs",
#   control = list(seed = 77),
#   verbose = TRUE
# )
# FindTopicsNumber_plot(result)
# 
# #manera 2
# # Build LDA Model
# data_lda <- LDA(data, k = 2, control = list(seed = 1234))
# data_lda
# as.data.frame(terms(data_lda, 15))
# 
# #manera 3
# burnin <-1000
# #set iterations
# iter<-2000
# #thin the spaces between samples
# thin <- 500
# #set random starts at 5
# nstart <-5
# #use random integers as seed 
# seed <- list(254672,109,122887,145629037,2)
# # return the highest probability as the result
# best <-TRUE
# #set number of topics 
# k <-5
# #run the LDA model
# ldaOut <- LDA(tdm,k, method="Gibbs", control=
#                 list(nstart=nstart, seed = seed, best=best, burnin = burnin, iter = iter, thin=thin))
# terms(ldaOut,6)
# https://bookdown.org/tianyuan09/ai4ph2022/tutorial2.html
```

```{r, echo = FALSE, include=FALSE}
# intent 4
library(tidyverse)
library(readr)
# a collection of package for data wrangling.
library(tidyverse)
# package for text processing
library(tidytext)
# collection of packages for modeling and L 

library(scales)
library(quanteda)
library(SnowballC)
library(topicmodels)
# install.packages("textrecipes")
library(textrecipes)

# install.packages("themis")
library(themis)

# install.packages("discrim")
library(discrim)

# install.packages("vip")
library(vip)

word_counts_dtm = data %>% count(freq, term) %>% cast_dfm(freq, term, n)

topfeatures(word_counts_dtm, n = 20, scheme = "docfreq")

lda2 <- LDA(word_counts_dtm, k = 2, control = list(seed = 1234))
lda2
as.data.frame(terms(lda2, 15))

lda4 <- LDA(word_counts_dtm, k = 4, control = list(seed = 1234))
lda4
as.data.frame(terms(lda4, 15))

lda_topics <- tidy(lda2, matrix = "beta")

lda_topics

lda_topics4 <-tidy(lda4,matrix="beta")
lda_topics4
```

### Per dos tòpics

Dividint les respostes dels alumnes en dos temes:

```{r, out.width="90%"}
# terms that are more common with each topic 
ap_top_terms <- lda_topics %>%
  group_by(topic) %>%
  slice_max(beta, n = 15) %>% 
  ungroup() %>%
  arrange(topic, -beta)

ap_top_terms %>%
  mutate(term = reorder_within(term, beta, topic)) %>%
  ggplot(aes(beta, term, fill = factor(topic))) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~ topic, scales = "free") +
  scale_y_reordered()+
  labs(title = "The terms that are most common within each topic")
```

```{r, out.width="90%"}
# terms that generate the greatest differences in beta btween two topics 
beta_wide <- lda_topics %>%
  mutate(topic = paste0("topic", topic)) %>%
  pivot_wider(names_from = topic, values_from = beta) %>% 
  filter(topic1 > .001 | topic2 > .001) %>%
  mutate(log_ratio = log2(topic2 / topic1))

beta_wide %>% arrange(desc(abs(log_ratio)))%>% head(20) %>% 
  arrange(desc(log_ratio)) %>%
  ggplot(aes(log_ratio, term)) +
  geom_col(show.legend = FALSE)+
  labs(title = "Terms with the great difference in beta between two topics")

lda_documents <- tidy(lda2, matrix = "gamma")
```

### Per quatre tòpics

Dividint les respostes dels alumnes en quatre grups:

```{r, out.width="90%"}
# for 4 topics 
ap_top_terms4 <- lda_topics4 %>%
  group_by(topic) %>%
  slice_max(beta, n = 15) %>% 
  ungroup() %>%
  arrange(topic, -beta)

ap_top_terms4 %>%
  mutate(term = reorder_within(term, beta, topic)) %>%
  ggplot(aes(beta, term, fill = factor(topic))) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~ topic, scales = "free") +
  scale_y_reordered()+
  labs(title = "The terms that are most common within each topic")
```

En el gràfic anterior es pot observar que el primer tema tracta els coneixements obtinguts a l'assignatura. El segon engloba els continguts i els materials del curs. El tercer està format sobretot per sentiments i opinions dels alumnes, mentre que el quart tema són la universitat i els professors. 

Cal tenir en compte que hi ha un nombre limitat de respostes i aquestes són poc diverses, el que implica que l'anàlisi de temes no és del tot significatiu.

\pagebreak

# Anàlisi comparativa i conclusió

Es fan servir mètodes per crear subpoblacions i poder diferenciar perfils dins les dades. La intenció és reduir la dimensionalitat de la matriu original mantenint la màxima informació possible. Es busca tenir un 80% d'inèrcia acumulada, per obtenir-la calen: 5 components principals a l'ACP, i 15 dimensions a l'ACM.

Al clustering jeràrquic, en primer lloc, s'arriba a la conclusió que el nombre òptim de clústers és 3, a partir de diversos mètodes: el de Ward amb la dissimilitud de Gower al quadrat, ajudant-se d’un dendrograma, el coeficient de Silhouette i la funció de R nbclust(). Fent-ne el profiling, es caracteritza el clúster 1 com al de les notes més baixes i més suspensos, que són els que deixen els estudis o no tenen beca. El segon clúster és el de les notes més altes i persones de països amb PIB més alt, són estudiants que s'han graduat, amb beca, majoritàriament dones i que tenen a classe al matí. El tercer clúster és el de les edats més altes i menys unitats suspeses, són persones que atenen de tarda i que tenen probabilitat igual de graduar-se com d'abandonar.

A l'anàlisi per components principals s'ha extret que, per arribar al 80% d'inèrcia, el nombre de components principals necessaris són cinc. Expliquen, en concret, el 84.32% de la inèrcia. Per tant, permeten explicar la major part de la variabilitat de les dades, el que significa que n'extreuen quasi tota la informació. En concret, s'ha trobat que per a la primera component les variables que més contribueixen són l'edat, de forma directa, i les notes dels dos semestres, de forma inversa. Veient les categòriques, es pot observar que aquest primer component es relaciona amb graduar-se o abandonar, els valors negatius correlacionats amb graduar-se i els positius amb abandonar. Les altres components no donen informació d'una forma tan directa.

Quan es fa el clustering a partir d'aquesta anàlisi, l'ACP, el nombre de clústers que en resulten són 7, que estan relacionats amb els originals, tot i que els especifiquen i diversifiquen més.

A l'anàlisi de correspondència múltiple, la conclusió és que, en funció de les zones dels gràfics, es poden distingir certes modalitats de diverses variables, el que implicaria associació. No es pot, però, arribar a trobar la relació entre les variables, i el percentatge de variància explicat per aquesta anàlisi és baix, el 24.25%. Les associacions principals trobades als diversos quadrants defineixen tres perfils, que resulten bastant específics. Es deuen repetir diverses vegades, però no semblen ser representatius d'una part significativa de l'alumnat.

A partir d'aquests mètodes s'han trobat resultats que, malgrat no coincidir de forma exacta, tenen sentit els uns amb els altres. Es defineixen diversos perfils amb diferents probabilitats de graduar-se i diferents notes, que són coherents entre els diversos mètodes, tot i que cadascun els presenta d'una forma diferent i amb un grau més alt o més baix d'especificitat.

A l'anàlisi discriminant lineal s'han buscat dues funcions discriminants per separar les tres modalitats de la variable target: enrolled, drop-out i graduate. S'ha observat que no és fàcil discriminar les tres modalitats a partir de les variables utilitzades. La precisió del model és baixa, del 15.7%, és a dir, que l'error de classificació és del 84.3%.

Es conclou, per tant, que la probabilitat de graduar-se no és independent de diversos factors com ara l'edat, el gènere, tenir beca o no, el PIB del país de procedència i l'horari en què es va a classe, ja que si es va de tardes de forma voluntària, és més probable que sigui perquè la persona treballa al matí, el que vol dir que té menys temps a dedicar als estudis, entre altres. També s'observa que hi ha diferents perfils d'estudiant, que tenen més o menys probabilitat de graduar-se en funció dels factors esmentats. Tot i això, cal tenir en compte que l’anàlisi discriminant mostra que no és possible predir de forma precisa la probabilitat de graduar-se d’una persona a partir d’aquests factors, així que, malgrat que es pot establir una correlació, aquesta no és prou forta per a fer prediccions.

L'anàlisi textual s'ha realitzat amb dades alienes a les originals, en vista que aquestes no tenien cap variable que apliqués. També tracten l'àmbit acadèmic. Després del preprocessament, s'ha observat que la paraula més comuna és good, i que hi ha quatre tòpics principals que són: coneixements obtinguts a les assignatures, continguts i materials del curs, sentiments i opinions de l'alumnat, i la universitat i el professorat. La base de dades no té una mida gaire gran, així que els resultats no són especialment significatius.

\pagebreak

# Pla de treball real

En finalitzar el treball es compara el pla de treball inicial amb el ritme de treball real. Per això, en aquest apartat es revisa punt a punt el pla de treball proposat al principi, per detectar possibles canvis i la incidència de riscos.

## Diagrama de Gantt

Per tal de complir els objectius del treball i seguir tots els punts que consten en el guió, es va dividir la feina en les següents tasques a desenvolupar.

1.  Motivació del treball, descripció formal de les dades i profiling de les dades crues

2.  Preprocessament

3.  Profiling dades preprocessades i clustering jeràrquic

4.  Preparar informe D3 i presentació 1

5.  ACP i ACM

6.  Clustering jeràrquic de l'ACP i l'ACM

7.  Anàlisi comparativa

8.  Conclusions

9.  Pla de treball real

10. Preparar informe D4 i presentació 2

Durant les últimes setmanes es van afegir dos apartats més per consideració dels professors: anàlisi discriminant i anàlisi textual. Llavors, les tasques han quedat així:

...

7.  Anàlisi discriminant

8.  Anàlisi textual

9.  Anàlisi comparativa

10. Conclusions

11. Pla de treball real

12. Preparar informe D4 i presentació 2

Aquesta és la planificació de tasques proposada a l'inici del treball.

```{r, out.width="95%"}
library(reshape2)
library(ggplot2)

df <- data.frame(
  name = factor(c("Tasca 01", "Tasca 02", "Tasca 03", "Tasca 04", "Tasca 05", "Tasca 06", "Tasca 07", "Tasca 08", "Tasca 09", "Tasca 10")),
  inici  = as.Date(c("2023-03-02", "2023-03-09", "2023-03-23", "2023-04-06", "2023-04-13", "2023-04-20", "2023-04-27", "2023-05-04", "2023-05-11", "2023-05-18")),
  final = as.Date(c("2023-03-08", "2023-03-22", "2023-04-05", "2023-04-12", "2023-04-19", "2023-04-26", "2023-05-03", "2023-05-10", "2023-05-17", "2023-05-24")))

ggplot (df, aes (x = inici, xend = final, y = name, yend = name, colour = name)) + 
  theme_bw () +
  geom_segment (size = 8) +
  labs (title = 'Diagrama de Gantt', x = NULL, y = NULL, legend = NULL) +
  geom_area() +
  theme(legend.position="none")
```

I aquesta és la temporalització i el ritme real de les tasques.

```{r, out.width="95%"}
ds <- data.frame(
  name = factor(c("Tasca 01", "Tasca 02", "Tasca 03", "Tasca 04", "Tasca 05", "Tasca 06", "Tasca 07", "Tasca 08", "Tasca 09", "Tasca 10", "Tasca 11", "Tasca 12")),
  inici  = as.Date(c("2023-03-02", "2023-03-09", "2023-03-23", "2023-04-06", "2023-04-20", "2023-05-04", "2023-05-11", "2023-05-18", "2023-05-18", "2023-05-18", "2023-05-21","2023-05-11")),
  final = as.Date(c("2023-03-08", "2023-03-22", "2023-04-05", "2023-04-12", "2023-05-10", "2023-05-14", "2023-05-17", "2023-05-21", "2023-05-23", "2023-05-23", "2023-05-24", "2023-05-24")))

ggplot (ds, aes (x = inici, xend = final, y = name, yend = name, colour = name)) + 
  theme_bw () +
  geom_segment (size = 8) +
  labs (title = 'Diagrama de Gantt real', x = NULL, y = NULL, legend = NULL) +
  geom_area() +
  theme(legend.position="none")
```

El pla de treball real s'ha vist afectat, especialment en les etapes finals, pel ritme de les classes de teoria, ja que es van plantejar tasques per abans que s'expliqués el tema corresponent a classe. La tasca de l'ACP i l'ACM n'és un exemple. A més, es va sobreestimar el temps que requeririen algunes tasques, i se'n van subestimar d'altres.

Al maig, s'han encavalcat moltes tasques a causa de dos factors: les dues tasques extres no previstes i la subestimació del temps necessari per a l'ACP i l'ACM, així com al clustering jeràrquic d'aquests. 

## Assignació de tasques

Les tasques descrites en l'anterior secció es van repartir entre els integrants del grup de la següent manera:

```{r, echo = FALSE}
df <- data.frame(
  tasques = factor(c("Motivació treball", "Descripció formal dades", "Profiling dades crues", "Preprocessament", "Profiling dades preprocessades", "Clustering jeràrquic", "Informe D3 i presentació 1", "ACP", "ACM", "Clustering jeràrquic ACP i ACM", "Anàlisi comparativa", "Conclusions", "Pla de treball real", "Informe D4 i presentació 2")),
  assignacio = factor(c("Grup 1", "Grup 2", "Grup 3", "Grup 4", "Grup 2", "Grup 1", "Tothom", "Grup 3", "Grup 4", "Grup 1", "Grup 2", "Tothom", "Grup 4", "Tothom")))
```

| Tasca                          | Aina i Oscar | Lucía i Laura T. | Mireia i Laura V. | Berta i Albert |
|---------------|:-------------:|:-------------:|:-------------:|:-------------:|
| Motivació treball              |      X       |                  |                   |                |
| Descripció formal dades        |              |        X         |                   |                |
| Profiling dades crues          |              |                  |         X         |                |
| Preprocessament                |              |                  |                   |       X        |
| Profiling dades preprocessades |              |        X         |                   |                |
| Clustering jeràrquic           |      X       |                  |                   |                |
| Informe D3 i presentació 1     |      X       |        X         |         X         |       X        |
| ACP                            |              |                  |         X         |                |
| ACM                            |              |                  |                   |       X        |
| Clustering jeràrquic ACP i ACM |      X       |                  |                   |                |
| Anàlisi comparativa            |              |        X         |                   |                |
| Conclusions                    |      X       |        X         |         X         |       X        |
| Pla treball real               |              |                  |                   |       X        |
| Informe D4 i presentació 2     |      X       |        X         |         X         |       X        |

Tots els grups han dut a terme les tasques assignades. Les dues tasques extres es van assignar als grups amb més disponibilitat de temps en el moment en què es van proposar els nous apartats. L'assignació de tasques final ha estat:

\pagebreak

| Tasca                          | Aina i Oscar | Lucía i Laura T. | Mireia i Laura V. | Berta i Albert |
|---------------|:-------------:|:-------------:|:-------------:|:-------------:|
| Motivació treball              |      X       |                  |                   |                |
| Descripció formal dades        |              |        X         |                   |                |
| Profiling dades crues          |              |                  |         X         |                |
| Preprocessament                |              |                  |                   |       X        |
| Profiling dades preprocessades |              |        X         |                   |                |
| Clustering jeràrquic           |      X       |                  |                   |                |
| Informe D3 i presentació 1     |      X       |        X         |         X         |       X        |
| ACP                            |              |                  |         X         |                |
| ACM                            |              |                  |                   |       X        |
| Clustering jeràrquic ACP i ACM |      X       |                  |                   |                |
| **Anàlisi discriminant**           |              |                  |         **X**         |                |
| **Anàlisi textual**                |              |                  |                   |       **X**        |
| Anàlisi comparativa            |              |        X         |                   |                |
| **Conclusions**                    |              |        **X**         |                   |                |
| Pla treball real               |              |                  |                   |       X        |
| Informe D4 i presentació 2     |      X       |        X         |         X         |       X        |

## Pla de riscos

Amb la premissa de prevenir que qualsevol imprevist s'agreugi i poder continuar la planificació, es va dur a terme el següent pla de riscos:

| Risc                                                                                                  | Impacte | Solució                                                                                                                      |
|----------------------------|:----------:|--------------------------------|
| Falta de temps acadèmic, retard en les tasques                                                        |   Alt   | Planificació amb suficient antelació. Si cal, reajustar el calendari, allargar i escurçar terminis.                          |
| Pèrdua de documents                                                                                   |   Alt   | Possible recuperació de versions anteriors. Tenir còpies de totes les actualitzacions (Drive i Github).                      |
| Renúncia o pèrdua de l'avaluació contínua                                                             | Moderat | Es reorganitzen els grups.                                                                                                   |
| Incapacitat per treballar (indisposició, malalties, problemes personals, problemes informàtics, etc.) | Moderat | Si la tasca té poc pes, la fa la parella. Si és molta feina, s'encarrega un altre grup que no tingui cap tasca en el moment. |
| Conflictes entre parelles                                                                             |  Baix   | Intentar solucionar els problemes amb ajuda d'algun membre com a mediador. Si no s'aconsegueix, reestructuració dels grups.  |

Al final del projecte, s'han revisat la incidència dels riscos previstos i de no previstos. Queden resumits en la taula següent:

| Risc                                                                                                  | Incidència | Accions                                                                                                                      |
|----------------------------|:----------:|--------------------------------|
| Falta de temps acadèmic, retard en les tasques                                                        |   Alt   | S'ha reajustat el calendari, allargant i escurçant terminis.                          |
| Pèrdua de documents                                                                                   |   No succeït   | |
| Renúncia o pèrdua de l'avaluació contínua                                                             | No succeït |      |                                                                                              |
| Incapacitat per treballar (indisposició, malalties, problemes personals, problemes informàtics, etc.) | No succeït |  |
| Conflictes entre parelles                                                                             |  No succeït   | 
| **Calendari no compassat amb les classes teòriques**                                               | **Moderat**     | **S'ha reorganitzat el calendari, començant les tasques tan aviat com s'ha pogut** |

